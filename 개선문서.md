좋다. 목표(EC2 2대, 각 EC2는 Nginx → 내부의 앱 프로세스 4개(예: PM2) 로드밸런싱, CodeDeploy로 EC2 2대에 대해 블루/그린 무중단 배포)를 달성하기 위해 받은 `DEPLOYMENT_SETUP_GUIDE.md` 문서를 **기술적·안전성·운영성 관점**에서 꼼꼼히 평가하고, 문서의 장점·문제점·구체적 개선안(명령어·스크립트·IAM 정책 샘플·AppSpec 훅 예시 포함)·검증 체크리스트를 모두 제공한다. 결론과 함께 배포 시 발생하기 쉬운 실전 이슈를 방지하는 실행 가능한 작업 목록을 단계별로 제시한다. 핵심 근거는 AWS 공식 문서 및 관련 베스트프랙티스 문서를 참조한다. ([AWS 문서][1])

---

# 1) 문서의 좋은 점 (정확한 부분)

* 전체 아키텍처 흐름(Internet → ALB → Blue/Green EC2)과 필요한 컴포넌트(ALB, CodeDeploy, GitLab CI/CD, S3 등)를 한눈에 정리한 점은 실무에서 매우 유용하다. ([AWS 문서][1])
* CloudFormation 사용을 권장하고, 스택 배포·출력값 활용(예: ALB DNS, Listener ARN)을 설명한 점은 인프라를 재현 가능하게 만든다. ([AWS 문서][2])
* 배포·검증·트러블슈팅 명령어(aws CLI 예시)와 로그 위치 정리는 운영자가 실무에서 빠르게 대응할 수 있게 한다. ([Amazon Web Services, Inc.][3])

---

# 2) 문서의 문제점 및 놓친 부분 (중요 — 반드시 수정 필요)

아래 항목들은 서비스 가용성과 보안, 롤백/무중단 특성에 직접적인 영향을 주므로 반드시 반영해야 한다.

## A. **과도하게 광범위한 IAM 권한** (심각)

문서의 IAM 권한 제안은 `AmazonEC2FullAccess`, `IAMFullAccess`, `AmazonS3FullAccess` 등 관리자급 권한들을 그대로 붙이라고 되어 있음. 이는 실운영 환경에서 위험하다. CI/CD용 계정은 **최소 권한(least privilege)** 원칙을 지켜야 하며, 가능하면 장기적 액세스 키 대신 GitLab → AWS OIDC/AssumeRole 같은 임시 자격 증명 방식을 사용하라. ([AWS 문서][4], [Medium][5])

### 개선 제안(요약)

* GitLab Runner가 AWS 리소스에 접근해야 하면, IAM 사용자/액세스 키 대신 **OIDC + IAM Role**(GitLab의 OIDC 지원) 또는 임시 자격증명을 사용. ([Medium][5])
* 정책은 리소스(예: 특정 S3 버킷, 특정 ALB 리스너, 특정 CodeDeploy 애플리케이션)에 **리소스 수준 제약**을 걸어 생성.
* 절대 `IAMFullAccess`, `AmazonEC2FullAccess` 같은 broad 권한을 붙이지 말 것.

---

## B. **CodeDeploy 블루/그린 동작·전환의 상세 고려 부족**

문서에서는 ALB 리스너를 변경해 트래픽을 전환하는 과정을 기술했지만, CodeDeploy가 제공하는 블루/그린 전환 방식(대체 환경(ASG) 생성 → ALB 대상 그룹 전환 → 검증 → 트래픽 전환)을 제대로 설명·활용하면 더 안전하다. CodeDeploy는 ASG 기반 블루/그린 워크플로우를 자동화할 수 있으며, 수동으로 ModifyListener 하는 접근과 충돌할 수 있으므로 전략을 통일해야 한다. ([AWS 문서][1], [Amazon Web Services, Inc.][3])

### 개선 포인트

* CloudFormation 템플릿에서 **CodeDeploy Application/DeploymentGroup**을 미리 정의하고, ALB target-groups/ASG 연결을 함께 구성하라. CodeDeploy 설정에서 트래픽 전환 정책(즉시 전환 vs 단계적 전환)과 안정화(health check) 기간을 설정. ([AWS 문서][2])

---

## C. **NGINX + PM2(앱 프로세스) 구성에서의 연결 종료(graceful shutdown)·health 체크·deregistration 지연 미반영**

* 내부 nginx 가 EC2 내부의 4개 프로세스(PM2)로 프록시하는 구조라면, 배포 중 인스턴스의 요청을 안전하게 떼어내고 프로세스를 재시작해야 한다. CodeDeploy의 `AppSpec` hooks(예: `ApplicationStop`, `BeforeInstall`, `AfterInstall`, `ApplicationStart`)에서 PM2의 graceful stop, nginx reload(또는 `nginx -s reload`)를 잘 처리하지 않으면 커넥션 손실이 발생한다. 또한 ALB의 deregistration delay 설정으로 기존 인스턴스의 연결을 draining 하도록 설정해야 한다. ([AWS 문서][1])

### 개선 포인트(예시)

* `ApplicationStop`에서 `pm2 gracefulReload` 또는 `pm2 stop <app>` + wait for connections to drain
* `BeforeInstall`에서 새 릴리스로 파일/종속성 복사
* `AfterInstall`에서 `pm2 start` → health endpoint가 ready 될 때까지 대기
* ALB TargetGroup의 `deregistration delay`를 (예: 300초)로 충분히 길게 설정

(아래에 AppSpec 훅 예시 스크립트를 제공함)

---

## D. **Health check와 ALB Target Group 설정·검증 절차 미흡**

* ALB의 health check는 EC2의 nginx endpoint(예: `/health` 혹은 `/health/deep`)로 맞출 것. nginx가 내부 앱에 프록시하므로 health endpoint는 nginx → backend 모두가 정상인지 확인하도록 구현. 또한 health check path·interval·timeout 값을 명시화할 것. ([AWS 문서][1])

---

## E. **데이터베이스 마이그레이션 및 스테이트풀 변경 전략 부재**

* Blue/Green은 앱 코드 전환은 쉽지만 DB 스키마 변경(비호환 변경)은 위험하다. 문서에 마이그레이션 전략(Backward/Forward compatible migration, Blue/Green에서 단계적 마이그레이션 또는 Feature flags 사용) 항목이 빠져 있다.

---

# 3) 구체적 수정·추가 제안 (코드/스크립트/정책 포함) — 바로 적용 가능

---

## 3.1 IAM 정책(현 문서의 사용자 정의 정책을 **최소 권한** 형태로 개선한 예시)

> 목적: GitLab 파이프라인이 특정 S3 버킷에 아티팩트를 업로드하고 CodeDeploy에 배포 생성, ALB 대상그룹/리스너 읽기 및 변경 정도만 허용

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowS3ArtifactAccess",
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::bluegreen-codedeploy-artifacts-123456789012",
        "arn:aws:s3:::bluegreen-codedeploy-artifacts-123456789012/*"
      ]
    },
    {
      "Sid": "AllowCodeDeployActions",
      "Effect": "Allow",
      "Action": [
        "codedeploy:CreateDeployment",
        "codedeploy:GetApplication",
        "codedeploy:GetDeployment",
        "codedeploy:GetDeploymentConfig",
        "codedeploy:ListDeployments",
        "codedeploy:StopDeployment"
      ],
      "Resource": [
        "arn:aws:codedeploy:ap-northeast-2:123456789012:application:bluegreen-deployment-production-app",
        "arn:aws:codedeploy:ap-northeast-2:123456789012:deploymentgroup:bluegreen-deployment-production-app/*"
      ]
    },
    {
      "Sid": "AllowELBReadAndModifySpecificListener",
      "Effect": "Allow",
      "Action": [
        "elasticloadbalancing:DescribeTargetGroups",
        "elasticloadbalancing:DescribeListeners",
        "elasticloadbalancing:DescribeTargetHealth",
        "elasticloadbalancing:ModifyListener"
      ],
      "Resource": "*"
    }
  ]
}
```

> 설명: `ModifyListener`에 대해 리소스 레벨 제한 예시는 복잡(ARN의 형태 등)하므로 `*`를 임시 허용하되, 운영 환경에선 리스너 ARN을 정확히 명시하라. 또한 가능하면 OIDC + AssumeRole 사용 권장. ([AWS 문서][6])

---

## 3.2 GitLab → AWS 연동 권장 방식

* **권장**: GitLab CI에서 AWS 액세스 키 대신 **OIDC (OpenID Connect)** 또는 `assume-role` 을 사용해 임시 자격증명을 취득하여 배포. (더 안전) ([Medium][5], [Amazon Web Services, Inc.][7])

---

## 3.3 AppSpec.yml 예시 + 훅 스크립트 (Node/PM2 + Nginx 환경 가정)

`appspec.yml` (CodeDeploy EC2용, root 권한으로 실행되는 스크립트 호출 방식)

```yaml
version: 0.0
os: linux
files:
  - source: /
    destination: /opt/bluegreen-app
hooks:
  ApplicationStop:
    - location: scripts/stop_app.sh
      timeout: 600
      runas: root
  BeforeInstall:
    - location: scripts/before_install.sh
      timeout: 600
      runas: root
  AfterInstall:
    - location: scripts/after_install.sh
      timeout: 600
      runas: root
  ApplicationStart:
    - location: scripts/start_app.sh
      timeout: 600
      runas: root
  ValidateService:
    - location: scripts/validate_service.sh
      timeout: 300
      runas: root
```

`stop_app.sh` (예시)

```bash
#!/bin/bash
set -e
# PM2 graceful stop
if command -v pm2 >/dev/null 2>&1; then
  pm2 gracefulReload all || pm2 stop all || true
fi
# Give connections time to drain
sleep 10
# reload nginx to remove/refresh config if needed
if systemctl is-active --quiet nginx; then
  nginx -s reload || true
fi
```

`start_app.sh`

```bash
#!/bin/bash
set -e
cd /opt/bluegreen-app
# install deps if needed
npm ci --production
# start via pm2
pm2 start ecosystem.config.js --env production
# ensure nginx is running
systemctl restart nginx
```

`validate_service.sh`

```bash
#!/bin/bash
set -e
ALB_DNS_NAME="${ALB_DNS_NAME:-localhost}"
# wait for health endpoint
for i in $(seq 1 20); do
  status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/health || true)
  if [ "$status" = "200" ]; then
    exit 0
  fi
  sleep 3
done
exit 1
```

> 목적: 배포 중 프로세스 재시작으로 인한 연결 끊김을 최소화하고, 헬스 체크가 `200`일 때만 배포 성공으로 간주. CodeDeploy의 `ValidateService` 훅은 배포의 최종 검증에 유용하다. ([AWS 문서][1])

---

## 3.4 ALB Target Group / Deregistration delay 및 Health check 권장값

* Health check path: `/health` 또는 `/health/deep` (응답 시간·의존성 고려)
* Health check interval: 10s, timeout: 5s, unhealthy threshold: 2, healthy threshold: 3 (서비스 특성에 맞게 조정)
* Deregistration delay: **최소 300초** 권장(긴 요청/keep-alive가 있을 경우 더 길게) — 이 값은 백엔드가 접속 draining에 필요한 시간을 준다. CodeDeploy와 연동 시 ALB가 인스턴스를 deregister 하는 동안 기존 연결을 유지할 수 있게 함. ([AWS 문서][1])

---

## 3.5 롤링/블루그린 전략 통일

* 문서에 나온 “CloudFormation → 수동 ModifyListener” 방식과 “CodeDeploy의 자동 트래픽 스위치” 중 하나를 선택하고 파이프라인 설계(수동 승인·자동 전환 등)를 통일하라. CodeDeploy의 블루/그린 워크플로우를 사용하면 배포와 트래픽 전환, 실패 시 자동 롤백 옵션을 활용할 수 있다. ([AWS 문서][2], [Amazon Web Services, Inc.][3])

---

# 4) 배포 검증 체크리스트 (배포 전/중/후 체크 항목)

**배포 전**

* [ ] CloudFormation 스택 출력(ALB ARN, Listener ARN, TargetGroup ARN, ASG 이름) 확보. ([AWS 문서][2])
* [ ] GitLab → AWS 인증(권한/방법) 확인: OIDC/AssumeRole 구성 여부. ([Medium][5])
* [ ] AppSpec, 훅 스크립트가 인스턴스에서 정상 작동(수동 테스트) 확인.

**배포 중**

* [ ] CodeDeploy 상태·인스턴스별 로그 확인 (`aws deploy get-deployment`) 및 실패 인스턴스 즉시 접근. ([AWS 문서][1])
* [ ] ALB TargetGroup의 TargetHealth 확인으로 프로비저닝 중 문제 감지. ([AWS 문서][1])

**배포 후**

* [ ] ALB DNS로 health / version 경로 확인(HTTP 200, 버전 반영 확인).
* [ ] CloudWatch 지표(5xx 증가, TargetResponseTime 증가 등) 모니터링. ([AWS 문서][8])

---

# 5) 실제 운영에서 자주 마주치는 문제(원인 + 해결)

1. **Target이 Unhealthy**: nginx 헬스 체킹 경로가 잘못되었거나 nginx → backend 연결 실패. → nginx config, backend 포트 확인, `curl localhost/health` 검증. ([AWS 문서][1])
2. **배포 후 일부 세션이 끊김**: deregistration delay가 너무 짧거나 graceful shutdown 미구현. → PM2 gracefulReload, deregistration delay 증가.
3. **권한 오류(AWS API 호출 실패)**: IAM 권한이 부족하거나 키가 만료. → `aws sts get-caller-identity`로 확인, 최소 권한 정책 검토. ([AWS 문서][4])

---

# 6) 문서에서 바로 고쳐야 할 구체적 문장/설정(권장 변경)

* `IAMFullAccess`, `AmazonEC2FullAccess`, `AmazonS3FullAccess`를 권장하는 부분을 **제거**하고, 대신 위에 제시한 최소 권한 예시를 넣을 것. ([AWS 문서][4])
* “ALB 리스너를 수동으로 ModifyListener 해서 트래픽을 전환한다”는 설명은 CodeDeploy 자동 트래픽 전환과 혼동할 수 있으니, \*\*두 방법(수동 vs CodeDeploy-managed)\*\*을 비교한 후 한 가지 방법만 프로세스에 맞춰 선택하도록 문서를 수정할 것. ([AWS 문서][1])
* `AppSpec` 훅(파일/스크립트 예시)을 문서에 추가. (위 예시 스크립트를 문서에 포함)

---

# 7) 결론 (요약)

* 문서는 아키텍처와 절차의 골격을 잘 잡아놓았으나, **보안(IAM)·배포 전환의 자동화 일관성(CodeDeploy vs 수동)·실전용 AppSpec 훅·헬스체크/드레인 설정**이 미흡하다. 위에서 제시한 IAM 최소권한 샘플, AppSpec 훅 예시, ALB 설정 권장값, OIDC 권장 등은 반드시 반영해야 안전하고 신뢰성 높은 블루/그린 무중단 배포가 된다. ([AWS 문서][1], [Medium][5])

---

# 8) 다음 단계(우선 적용 권장 순서)

1. GitLab → AWS 인증을 **OIDC/AssumeRole**으로 전환(가장 시급). ([Medium][5])
2. AppSpec + 훅 스크립트를 작성해 EC2에서 수동으로 돌려 테스트(시뮬레이션).
3. CloudFormation 템플릿에서 CodeDeploy Application/DeploymentGroup, ALB TargetGroups, ASG를 함께 구성하도록 수정. ([AWS 문서][2])
4. ALB target group health path·deregistration delay·CodeDeploy traffic routing 정책(단계적/즉시)을 확정.
5. 자동화 파이프라인(Deploy job)에 수동 승인(Production) 단계 추가 및 모니터링 알람 설정.

---

## 참고 자료(권위 있는 출처)

* CodeDeploy: Create a deployment group for an EC2/On-Premises blue/green deployment. ([AWS 문서][1])
* ModifyListener API 문서(ELB). ([AWS 문서][6])
* IAM 보안 모범 사례(최소 권한 권장). ([AWS 문서][4])
* CloudFormation blue/green template example. ([AWS 문서][2])
* CI/CD 보안·모범 사례(권장: OIDC 사용). ([AWS 문서][8], [Medium][5])

