좋다. 목표(EC2 2대, 각 EC2는 Nginx → 내부의 앱 프로세스 4개(예: PM2) 로드밸런싱, CodeDeploy로 EC2 2대에 대해 블루/그린 무중단 배포)를 달성하기 위해 받은 `DEPLOYMENT_SETUP_GUIDE.md` 문서를 **기술적·안전성·운영성 관점**에서 꼼꼼히 평가하고, 문서의 장점·문제점·구체적 개선안(명령어·스크립트·IAM 정책 샘플·AppSpec 훅 예시 포함)·검증 체크리스트를 모두 제공한다. 결론과 함께 배포 시 발생하기 쉬운 실전 이슈를 방지하는 실행 가능한 작업 목록을 단계별로 제시한다. 핵심 근거는 AWS 공식 문서 및 관련 베스트프랙티스 문서를 참조한다. ([AWS 문서][1])

---

# 1) 문서의 좋은 점 (정확한 부분)

* 전체 아키텍처 흐름(Internet → ALB → Blue/Green EC2)과 필요한 컴포넌트(ALB, CodeDeploy, GitLab CI/CD, S3 등)를 한눈에 정리한 점은 실무에서 매우 유용하다. ([AWS 문서][1])
* CloudFormation 사용을 권장하고, 스택 배포·출력값 활용(예: ALB DNS, Listener ARN)을 설명한 점은 인프라를 재현 가능하게 만든다. ([AWS 문서][2])
* 배포·검증·트러블슈팅 명령어(aws CLI 예시)와 로그 위치 정리는 운영자가 실무에서 빠르게 대응할 수 있게 한다. ([Amazon Web Services, Inc.][3])

---

# 2) 문서의 문제점 및 놓친 부분 (중요 — 반드시 수정 필요)

아래 항목들은 서비스 가용성과 보안, 롤백/무중단 특성에 직접적인 영향을 주므로 반드시 반영해야 한다.

## A. **과도하게 광범위한 IAM 권한** (심각)

문서의 IAM 권한 제안은 `AmazonEC2FullAccess`, `IAMFullAccess`, `AmazonS3FullAccess` 등 관리자급 권한들을 그대로 붙이라고 되어 있음. 이는 실운영 환경에서 위험하다. CI/CD용 계정은 **최소 권한(least privilege)** 원칙을 지켜야 하며, 가능하면 장기적 액세스 키 대신 GitLab → AWS OIDC/AssumeRole 같은 임시 자격 증명 방식을 사용하라. ([AWS 문서][4], [Medium][5])

### 개선 제안(요약)

* GitLab Runner가 AWS 리소스에 접근해야 하면, IAM 사용자/액세스 키 대신 **OIDC + IAM Role**(GitLab의 OIDC 지원) 또는 임시 자격증명을 사용. ([Medium][5])
* 정책은 리소스(예: 특정 S3 버킷, 특정 ALB 리스너, 특정 CodeDeploy 애플리케이션)에 **리소스 수준 제약**을 걸어 생성.
* 절대 `IAMFullAccess`, `AmazonEC2FullAccess` 같은 broad 권한을 붙이지 말 것.

---

## B. **CodeDeploy 블루/그린 동작·전환의 상세 고려 부족**

문서에서는 ALB 리스너를 변경해 트래픽을 전환하는 과정을 기술했지만, CodeDeploy가 제공하는 블루/그린 전환 방식(대체 환경(ASG) 생성 → ALB 대상 그룹 전환 → 검증 → 트래픽 전환)을 제대로 설명·활용하면 더 안전하다. CodeDeploy는 ASG 기반 블루/그린 워크플로우를 자동화할 수 있으며, 수동으로 ModifyListener 하는 접근과 충돌할 수 있으므로 전략을 통일해야 한다. ([AWS 문서][1], [Amazon Web Services, Inc.][3])

### 개선 포인트

* CloudFormation 템플릿에서 **CodeDeploy Application/DeploymentGroup**을 미리 정의하고, ALB target-groups/ASG 연결을 함께 구성하라. CodeDeploy 설정에서 트래픽 전환 정책(즉시 전환 vs 단계적 전환)과 안정화(health check) 기간을 설정. ([AWS 문서][2])

---

## C. **NGINX + PM2(앱 프로세스) 구성에서의 연결 종료(graceful shutdown)·health 체크·deregistration 지연 미반영**

* 내부 nginx 가 EC2 내부의 4개 프로세스(PM2)로 프록시하는 구조라면, 배포 중 인스턴스의 요청을 안전하게 떼어내고 프로세스를 재시작해야 한다. CodeDeploy의 `AppSpec` hooks(예: `ApplicationStop`, `BeforeInstall`, `AfterInstall`, `ApplicationStart`)에서 PM2의 graceful stop, nginx reload(또는 `nginx -s reload`)를 잘 처리하지 않으면 커넥션 손실이 발생한다. 또한 ALB의 deregistration delay 설정으로 기존 인스턴스의 연결을 draining 하도록 설정해야 한다. ([AWS 문서][1])

### 개선 포인트(예시)

* `ApplicationStop`에서 `pm2 gracefulReload` 또는 `pm2 stop <app>` + wait for connections to drain
* `BeforeInstall`에서 새 릴리스로 파일/종속성 복사
* `AfterInstall`에서 `pm2 start` → health endpoint가 ready 될 때까지 대기
* ALB TargetGroup의 `deregistration delay`를 (예: 300초)로 충분히 길게 설정

(아래에 AppSpec 훅 예시 스크립트를 제공함)

---

## D. **Health check와 ALB Target Group 설정·검증 절차 미흡**

* ALB의 health check는 EC2의 nginx endpoint(예: `/health` 혹은 `/health/deep`)로 맞출 것. nginx가 내부 앱에 프록시하므로 health endpoint는 nginx → backend 모두가 정상인지 확인하도록 구현. 또한 health check path·interval·timeout 값을 명시화할 것. ([AWS 문서][1])

---

## E. **데이터베이스 마이그레이션 및 스테이트풀 변경 전략 부재**

* Blue/Green은 앱 코드 전환은 쉽지만 DB 스키마 변경(비호환 변경)은 위험하다. 문서에 마이그레이션 전략(Backward/Forward compatible migration, Blue/Green에서 단계적 마이그레이션 또는 Feature flags 사용) 항목이 빠져 있다.

---

# 3) 구체적 수정·추가 제안 (코드/스크립트/정책 포함) — 바로 적용 가능

---

## 3.1 IAM 정책(현 문서의 사용자 정의 정책을 **최소 권한** 형태로 개선한 예시)

> 목적: GitLab 파이프라인이 특정 S3 버킷에 아티팩트를 업로드하고 CodeDeploy에 배포 생성, ALB 대상그룹/리스너 읽기 및 변경 정도만 허용

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowS3ArtifactAccess",
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::bluegreen-codedeploy-artifacts-123456789012",
        "arn:aws:s3:::bluegreen-codedeploy-artifacts-123456789012/*"
      ]
    },
    {
      "Sid": "AllowCodeDeployActions",
      "Effect": "Allow",
      "Action": [
        "codedeploy:CreateDeployment",
        "codedeploy:GetApplication",
        "codedeploy:GetDeployment",
        "codedeploy:GetDeploymentConfig",
        "codedeploy:ListDeployments",
        "codedeploy:StopDeployment"
      ],
      "Resource": [
        "arn:aws:codedeploy:ap-northeast-2:123456789012:application:bluegreen-deployment-production-app",
        "arn:aws:codedeploy:ap-northeast-2:123456789012:deploymentgroup:bluegreen-deployment-production-app/*"
      ]
    },
    {
      "Sid": "AllowELBReadAndModifySpecificListener",
      "Effect": "Allow",
      "Action": [
        "elasticloadbalancing:DescribeTargetGroups",
        "elasticloadbalancing:DescribeListeners",
        "elasticloadbalancing:DescribeTargetHealth",
        "elasticloadbalancing:ModifyListener"
      ],
      "Resource": "*"
    }
  ]
}
```

> 설명: `ModifyListener`에 대해 리소스 레벨 제한 예시는 복잡(ARN의 형태 등)하므로 `*`를 임시 허용하되, 운영 환경에선 리스너 ARN을 정확히 명시하라. 또한 가능하면 OIDC + AssumeRole 사용 권장. ([AWS 문서][6])

---

## 3.2 GitLab → AWS 연동 권장 방식

* **권장**: GitLab CI에서 AWS 액세스 키 대신 **OIDC (OpenID Connect)** 또는 `assume-role` 을 사용해 임시 자격증명을 취득하여 배포. (더 안전) ([Medium][5], [Amazon Web Services, Inc.][7])

---

## 3.3 AppSpec.yml 예시 + 훅 스크립트 (Node/PM2 + Nginx 환경 가정)

`appspec.yml` (CodeDeploy EC2용, root 권한으로 실행되는 스크립트 호출 방식)

```yaml
version: 0.0
os: linux
files:
  - source: /
    destination: /opt/bluegreen-app
hooks:
  ApplicationStop:
    - location: scripts/stop_app.sh
      timeout: 600
      runas: root
  BeforeInstall:
    - location: scripts/before_install.sh
      timeout: 600
      runas: root
  AfterInstall:
    - location: scripts/after_install.sh
      timeout: 600
      runas: root
  ApplicationStart:
    - location: scripts/start_app.sh
      timeout: 600
      runas: root
  ValidateService:
    - location: scripts/validate_service.sh
      timeout: 300
      runas: root
```

`stop_app.sh` (예시)

```bash
#!/bin/bash
set -e
# PM2 graceful stop
if command -v pm2 >/dev/null 2>&1; then
  pm2 gracefulReload all || pm2 stop all || true
fi
# Give connections time to drain
sleep 10
# reload nginx to remove/refresh config if needed
if systemctl is-active --quiet nginx; then
  nginx -s reload || true
fi
```

`start_app.sh`

```bash
#!/bin/bash
set -e
cd /opt/bluegreen-app
# install deps if needed
npm ci --production
# start via pm2
pm2 start ecosystem.config.js --env production
# ensure nginx is running
systemctl restart nginx
```

`validate_service.sh`

```bash
#!/bin/bash
set -e
ALB_DNS_NAME="${ALB_DNS_NAME:-localhost}"
# wait for health endpoint
for i in $(seq 1 20); do
  status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/health || true)
  if [ "$status" = "200" ]; then
    exit 0
  fi
  sleep 3
done
exit 1
```

> 목적: 배포 중 프로세스 재시작으로 인한 연결 끊김을 최소화하고, 헬스 체크가 `200`일 때만 배포 성공으로 간주. CodeDeploy의 `ValidateService` 훅은 배포의 최종 검증에 유용하다. ([AWS 문서][1])

---

## 3.4 ALB Target Group / Deregistration delay 및 Health check 권장값

* Health check path: `/health` 또는 `/health/deep` (응답 시간·의존성 고려)
* Health check interval: 10s, timeout: 5s, unhealthy threshold: 2, healthy threshold: 3 (서비스 특성에 맞게 조정)
* Deregistration delay: **최소 300초** 권장(긴 요청/keep-alive가 있을 경우 더 길게) — 이 값은 백엔드가 접속 draining에 필요한 시간을 준다. CodeDeploy와 연동 시 ALB가 인스턴스를 deregister 하는 동안 기존 연결을 유지할 수 있게 함. ([AWS 문서][1])

---

## 3.5 롤링/블루그린 전략 통일

* 문서에 나온 “CloudFormation → 수동 ModifyListener” 방식과 “CodeDeploy의 자동 트래픽 스위치” 중 하나를 선택하고 파이프라인 설계(수동 승인·자동 전환 등)를 통일하라. CodeDeploy의 블루/그린 워크플로우를 사용하면 배포와 트래픽 전환, 실패 시 자동 롤백 옵션을 활용할 수 있다. ([AWS 문서][2], [Amazon Web Services, Inc.][3])

---

# 4) 배포 검증 체크리스트 (배포 전/중/후 체크 항목)

**배포 전**

* [ ] CloudFormation 스택 출력(ALB ARN, Listener ARN, TargetGroup ARN, ASG 이름) 확보. ([AWS 문서][2])
* [ ] GitLab → AWS 인증(권한/방법) 확인: OIDC/AssumeRole 구성 여부. ([Medium][5])
* [ ] AppSpec, 훅 스크립트가 인스턴스에서 정상 작동(수동 테스트) 확인.

**배포 중**

* [ ] CodeDeploy 상태·인스턴스별 로그 확인 (`aws deploy get-deployment`) 및 실패 인스턴스 즉시 접근. ([AWS 문서][1])
* [ ] ALB TargetGroup의 TargetHealth 확인으로 프로비저닝 중 문제 감지. ([AWS 문서][1])

**배포 후**

* [ ] ALB DNS로 health / version 경로 확인(HTTP 200, 버전 반영 확인).
* [ ] CloudWatch 지표(5xx 증가, TargetResponseTime 증가 등) 모니터링. ([AWS 문서][8])

---

# 5) 실제 운영에서 자주 마주치는 문제(원인 + 해결)

1. **Target이 Unhealthy**: nginx 헬스 체킹 경로가 잘못되었거나 nginx → backend 연결 실패. → nginx config, backend 포트 확인, `curl localhost/health` 검증. ([AWS 문서][1])
2. **배포 후 일부 세션이 끊김**: deregistration delay가 너무 짧거나 graceful shutdown 미구현. → PM2 gracefulReload, deregistration delay 증가.
3. **권한 오류(AWS API 호출 실패)**: IAM 권한이 부족하거나 키가 만료. → `aws sts get-caller-identity`로 확인, 최소 권한 정책 검토. ([AWS 문서][4])

---

# 6) 문서에서 바로 고쳐야 할 구체적 문장/설정(권장 변경)

* `IAMFullAccess`, `AmazonEC2FullAccess`, `AmazonS3FullAccess`를 권장하는 부분을 **제거**하고, 대신 위에 제시한 최소 권한 예시를 넣을 것. ([AWS 문서][4])
* “ALB 리스너를 수동으로 ModifyListener 해서 트래픽을 전환한다”는 설명은 CodeDeploy 자동 트래픽 전환과 혼동할 수 있으니, \*\*두 방법(수동 vs CodeDeploy-managed)\*\*을 비교한 후 한 가지 방법만 프로세스에 맞춰 선택하도록 문서를 수정할 것. ([AWS 문서][1])
* `AppSpec` 훅(파일/스크립트 예시)을 문서에 추가. (위 예시 스크립트를 문서에 포함)

---

# 7) 결론 (요약)

* 문서는 아키텍처와 절차의 골격을 잘 잡아놓았으나, **보안(IAM)·배포 전환의 자동화 일관성(CodeDeploy vs 수동)·실전용 AppSpec 훅·헬스체크/드레인 설정**이 미흡하다. 위에서 제시한 IAM 최소권한 샘플, AppSpec 훅 예시, ALB 설정 권장값, OIDC 권장 등은 반드시 반영해야 안전하고 신뢰성 높은 블루/그린 무중단 배포가 된다. ([AWS 문서][1], [Medium][5])

---

# 8) 다음 단계(우선 적용 권장 순서)

1. GitLab → AWS 인증을 **OIDC/AssumeRole**으로 전환(가장 시급). ([Medium][5])
2. AppSpec + 훅 스크립트를 작성해 EC2에서 수동으로 돌려 테스트(시뮬레이션).
3. CloudFormation 템플릿에서 CodeDeploy Application/DeploymentGroup, ALB TargetGroups, ASG를 함께 구성하도록 수정. ([AWS 문서][2])
4. ALB target group health path·deregistration delay·CodeDeploy traffic routing 정책(단계적/즉시)을 확정.
5. 자동화 파이프라인(Deploy job)에 수동 승인(Production) 단계 추가 및 모니터링 알람 설정.

---

## 참고 자료(권위 있는 출처)

* CodeDeploy: Create a deployment group for an EC2/On-Premises blue/green deployment. ([AWS 문서][1])
* ModifyListener API 문서(ELB). ([AWS 문서][6])
* IAM 보안 모범 사례(최소 권한 권장). ([AWS 문서][4])
* CloudFormation blue/green template example. ([AWS 문서][2])
* CI/CD 보안·모범 사례(권장: OIDC 사용). ([AWS 문서][8], [Medium][5])

# AppSpec + Hook scripts + CloudFormation (Blue/Green for EC2 with ALB + CodeDeploy)

이 문서는 다음을 포함한다:

1. `appspec.yml` (EC2 배포용).
2. AppSpec 훅에서 호출할 배포 스크립트(예: pm2 + nginx 환경에 맞춘 `stop`, `before_install`, `after_install`, `start`, `validate`).
3. CloudFormation 템플릿 조각: ALB, TargetGroup, LaunchTemplate, AutoScalingGroup, CodeDeploy Application & DeploymentGroup(Blue/Green 설정), 필요한 IAM Role과 정책 샘플.

---

## 1) appspec.yml (완전판)

```yaml
version: 0.0
os: linux
files:
  - source: /
    destination: /opt/bluegreen-app

hooks:
  BeforeBlockTraffic:
    - location: scripts/before_block_traffic.sh
      timeout: 600
      runas: root

  ApplicationStop:
    - location: scripts/stop_app.sh
      timeout: 600
      runas: root

  BeforeInstall:
    - location: scripts/before_install.sh
      timeout: 600
      runas: root

  AfterInstall:
    - location: scripts/after_install.sh
      timeout: 600
      runas: root

  ApplicationStart:
    - location: scripts/start_app.sh
      timeout: 600
      runas: root

  ValidateService:
    - location: scripts/validate_service.sh
      timeout: 300
      runas: root
```

> 설명: `BeforeBlockTraffic` 훅은 CodeDeploy의 블루/그린 트래픽 전환 과정에서 '블루' (또는 대체 환경)에서 트래픽을 차단하기 전에 필요한 작업(예: health endpoint 변경, 세션 flush 등)을 수행하게 해준다. `ValidateService`는 배포 마지막 단계에서 서비스 준비 상태를 확인한다.

---

## 2) Hook scripts (실전용 샘플)

> **모두 실행 권한 필요**: `chmod +x scripts/*.sh`

### scripts/stop\_app.sh

```bash
#!/bin/bash
set -euo pipefail
LOGFILE=/var/log/codedeploy/hooks-stop.log
exec 2>>${LOGFILE}
exec 1>>${LOGFILE}

# graceful stop: pm2 기준
if command -v pm2 >/dev/null 2>&1; then
  pm2 gracefulReload all || pm2 stop all || true
fi

# nginx reload to remove old upstreams if config changed
if systemctl is-active --quiet nginx; then
  nginx -s reload || true
fi

# wait short period for connections to drain
sleep 5

echo "ApplicationStop complete: $(date)" >> ${LOGFILE}
```

### scripts/before\_install.sh

```bash
#!/bin/bash
set -euo pipefail
LOGFILE=/var/log/codedeploy/hooks-before_install.log
exec 2>>${LOGFILE}
exec 1>>${LOGFILE}

# backup current release (optional)
if [ -d /opt/bluegreen-app ]; then
  timestamp=$(date +%Y%m%d%H%M%S)
  mv /opt/bluegreen-app /opt/bluegreen-app.backup.${timestamp} || true
fi

# create destination dir
mkdir -p /opt/bluegreen-app
chown -R ec2-user:ec2-user /opt/bluegreen-app || true

echo "BeforeInstall complete: $(date)" >> ${LOGFILE}
```

### scripts/after\_install.sh

```bash
#!/bin/bash
set -euo pipefail
LOGFILE=/var/log/codedeploy/hooks-after_install.log
exec 2>>${LOGFILE}
exec 1>>${LOGFILE}

cd /opt/bluegreen-app || exit 1
# Install dependencies (Node example -- adjust for your stack)
if [ -f package.json ]; then
  # use npm ci for reproducible installs
  npm ci --production
fi

# apply nginx config if present in artifact
if [ -f deploy/nginx.conf ]; then
  cp deploy/nginx.conf /etc/nginx/conf.d/bluegreen_app.conf
fi

chown -R ec2-user:ec2-user /opt/bluegreen-app || true

echo "AfterInstall complete: $(date)" >> ${LOGFILE}
```

### scripts/start\_app.sh

```bash
#!/bin/bash
set -euo pipefail
LOGFILE=/var/log/codedeploy/hooks-start.log
exec 2>>${LOGFILE}
exec 1>>${LOGFILE}

cd /opt/bluegreen-app

# start app via pm2 ecosystem (환경에 맞게 변경)
if command -v pm2 >/dev/null 2>&1; then
  pm2 startOrReload ecosystem.config.js --env production
else
  # fallback: node server.js &
  nohup node server.js &
fi

# restart nginx to pickup config changes
if systemctl is-active --quiet nginx; then
  systemctl restart nginx || nginx -s reload || true
fi

# give some time for services to warm up
sleep 3

echo "ApplicationStart complete: $(date)" >> ${LOGFILE}
```

### scripts/validate\_service.sh

```bash
#!/bin/bash
set -euo pipefail
LOGFILE=/var/log/codedeploy/hooks-validate_service.log
exec 2>>${LOGFILE}
exec 1>>${LOGFILE}

# Health check loop: localhost에서 헬스엔드포인트 확인
HEALTH_URL="http://localhost/health"
RETRIES=20
SLEEP=3

for i in $(seq 1 ${RETRIES}); do
  code=$(curl -s -o /dev/null -w "%{http_code}" ${HEALTH_URL} || true)
  if [ "${code}" == "200" ]; then
    echo "ValidateService: healthy after ${i} attempts" >> ${LOGFILE}
    exit 0
  fi
  sleep ${SLEEP}
done

# 건강하지 않으면 non-zero로 종료 -> CodeDeploy가 배포 실패로 처리
echo "ValidateService: unhealthy (last code=${code})" >> ${LOGFILE}
exit 1
```

### scripts/before\_block\_traffic.sh (선택적)

```bash
#!/bin/bash
set -euo pipefail
LOGFILE=/var/log/codedeploy/hooks-before_block_traffic.log
exec 2>>${LOGFILE}
exec 1>>${LOGFILE}

# 예: 세션을 외부 세션스토어로 flush하거나 read-only 모드 전환
# curl -X POST http://localhost/internal/flush-sessions

# 또는 nginx의 특정 백엔드를 비활성화할 필요가 있으면 여기서 처리

echo "BeforeBlockTraffic complete: $(date)" >> ${LOGFILE}
```

---

## 3) CloudFormation 템플릿 조각 (코어: ALB / TargetGroup / LaunchTemplate / ASG / CodeDeploy)

> 이 템플릿은 **샘플**이다. 실제 환경에 맞게 AMI, SecurityGroup, KeyName, Subnets, InstanceType, IAM Role ARNs 등을 채워야 한다.

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: EC2 + ALB + ASG + CodeDeploy BlueGreen (example snippet)

Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
  InstanceType:
    Type: String
    Default: t3.small
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName

Resources:
  AppLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Scheme: internet-facing
      Subnets: !Ref SubnetIds
      Type: application

  AppTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      VpcId: !Ref VpcId
      Protocol: HTTP
      Port: 80
      TargetType: instance
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 10
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 3
      UnhealthyThresholdCount: 2
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: '300'

  AppListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref AppLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref AppTargetGroup

  AppLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        ImageId: ami-REPLACE_ME
        InstanceType: !Ref InstanceType
        KeyName: !Ref KeyName
        SecurityGroupIds: [ sg-REPLACE_ME ]
        UserData: !Base64 |
          #!/bin/bash
          # install CodeDeploy agent, nginx, node, pm2 등
          # user-specific bootstrap steps

  AppAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      VPCZoneIdentifier: !Ref SubnetIds
      LaunchTemplate:
        LaunchTemplateId: !Ref AppLaunchTemplate
        Version: !GetAtt AppLaunchTemplate.LatestVersionNumber
      MinSize: '1'
      MaxSize: '2'
      DesiredCapacity: '1'
      TargetGroupARNs:
        - !Ref AppTargetGroup

  CodeDeployServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: [ codedeploy.amazonaws.com ]
            Action: sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole

  CodeDeployApplication:
    Type: AWS::CodeDeploy::Application
    Properties:
      ApplicationName: BlueGreen-App
      ComputePlatform: Server

  CodeDeployDeploymentGroup:
    Type: AWS::CodeDeploy::DeploymentGroup
    Properties:
      ApplicationName: !Ref CodeDeployApplication
      ServiceRoleArn: !GetAtt CodeDeployServiceRole.Arn
      DeploymentConfigName: CodeDeployDefault.AllAtOnce
      AutoScalingGroups:
        - !Ref AppAutoScalingGroup
      LoadBalancerInfo:
        ElbInfoList:
          - Name: !Ref AppLoadBalancer
      DeploymentStyle:
        DeploymentType: BLUE_GREEN
        DeploymentOption: WITH_TRAFFIC_CONTROL
      BlueGreenDeploymentConfiguration:
        TerminationWaitTimeInMinutes: 15
        DeploymentReadyOption:
          ActionOnTimeout: CONTINUE_DEPLOYMENT
          WaitTimeInMinutes: 0
        GreenFleetProvisioningOption:
          Action: DISCOVER_EXISTING
      TrafficRoutingConfig:
        Type: AllAtOnce

Outputs:
  LoadBalancerDNS:
    Value: !GetAtt AppLoadBalancer.DNSName
```

> 주의: CloudFormation의 `AWS::CodeDeploy::DeploymentGroup` 블루/그린 기능은 **ASG 기반** 리소스와 함께 사용할 때 동작한다. EC2 단일 인스턴스(ASG 없이) 또는 수동으로 리스너를 변경하는 방식과 혼용하면 충돌 가능성이 있으므로, 배포 전략을 명확히 하고 템플릿을 환경에 맞게 조정해야 한다.

---

## 4) 적용 시나리오 — 단계별 실행 흐름 (이유 포함)

1. **인프라 준비(CFN)**: ALB, TargetGroup(헬스체크), LaunchTemplate, ASG, CodeDeploy Application/DeploymentGroup, IAM Role 생성. 이유: CodeDeploy가 ASG를 인식하여 블루/그린 전환(신규 인스턴스 프로비저닝, TargetGroup 등록/해제)을 자동화하기 때문.
2. **애플리케이션 아티팩트 준비**: `appspec.yml`, `scripts/`, `deploy/`(nginx conf 등), 소스코드 패키징. 이유: AppSpec가 배포 라이프사이클을 제어하므로 아티팩트 내부의 경로와 스크립트가 정확해야 한다.
3. **GitLab CI/CD**: 아티팩트 빌드 → S3 업로드 → `aws deploy create-deployment` 호출(또는 CodePipeline 사용). 이유: 배포의 시작점.
4. **CodeDeploy가 배포 실행**: 새로운 ASG(그린)를 프로비저닝하거나 기존 ASG를 재사용(설정에 따라) → `BeforeBlockTraffic` → `ApplicationStop` → `BeforeInstall` → `AfterInstall` → `ApplicationStart` → `ValidateService` → 트래픽 전환 → 기존 블루 인스턴스 종료(또는 보존).
5. **검증 및 모니터링**: ALB target health, CloudWatch metrics, 로그 확인.

---

## 5) 테스트 및 검증 명령어 (운영자용)

* CodeDeploy 상태 및 최근 배포 확인:

```bash
aws deploy list-deployments --application-name BlueGreen-App --max-items 5
aws deploy get-deployment --deployment-id <DEPLOYMENT_ID>
```

* TargetGroup 상태 확인:

```bash
aws elbv2 describe-target-health --target-group-arn <TARGET_GROUP_ARN>
```

* 인스턴스에서 헬스 체크 수동 확인:

```bash
curl -v http://localhost/health
```

* 로그 파일 확인 (앱스펙 훅 로그):

```bash
sudo tail -n 200 /var/log/codedeploy/hooks-*.log
sudo tail -n 200 /var/log/nginx/error.log
sudo journalctl -u codedeploy-agent -n 200
```

---

## 6) 롤백 / 실패 처리

* `ValidateService` 훅 실패 시 CodeDeploy는 해당 배포를 실패로 표시한다. CodeDeploy 설정에서 자동 롤백(예: `automatic rollback on failed deployment`)을 켜면 자동으로 이전 상태로 되돌릴 수 있다.
* 수동 롤백 명령:

```bash
aws deploy stop-deployment --deployment-id <DEPLOYMENT_ID> --auto-rollback-enabled
```

---

## 7) 보안·운영 권장사항 요약

* GitLab → AWS 권한은 OIDC/AssumeRole을 사용해서 임시 권한으로 운영.
* IAM: CodeDeploy가 필요로 하는 최소 권한만 부여. CodeDeploy Service Role에 AWS 관리형 `AWSCodeDeployRole`을 연결.
* ALB target group의 `deregistration_delay.timeout_seconds`를 현재 기본값(300초)보다 응답특성에 맞게 조정.

---

## 8) 문서 내 교체/채워야 할 필드

* `ami-REPLACE_ME`, `sg-REPLACE_ME`, KeyName, SubnetIds, VpcId, Account ID 또는 특정 ARNs 등은 실제 값으로 교체해야 한다.
* `UserData` 스크립트는 인스턴스 부팅 시 `codedeploy-agent` 설치, nginx, node, pm2 설치를 포함하도록 반드시 작성.

---

작업 완료: 요청하신 **(1) `appspec.yml` + 훅 스크립트 완전판을 문서에 통합**과 **(2) CloudFormation 템플릿 조각의 CodeDeploy 연동부 안전 수정안**을 하나의 문서로 생성해두었습니다. 문서는 편히 확인할 수 있도록 별도 텍스트 문서로 올려두었으며(파일명: **Codedeploy Appspec And Cfn Bluegreen**), 다음 내용을 포함합니다.

* `appspec.yml` — CodeDeploy EC2(서버) 배포용 완전판(모든 lifecycle 훅 포함). ([AWS 문서][1])
* 훅 스크립트들 — `stop`, `before_install`, `after_install`, `start`, `validate`, `before_block_traffic` 등 실전용 스크립트(로그, 실패 시 non-zero 반환 규칙, pm2/nginx 명령 예시 포함). ([AWS 문서][2])
* CloudFormation 템플릿 조각 — ALB, TargetGroup(헬스체크·deregistration delay 포함), LaunchTemplate, AutoScalingGroup, CodeDeploy Application & DeploymentGroup(Blue/Green 설정 포함), CodeDeploy 서비스 역할 예시. CloudFormation에서 ASG 기반으로 CodeDeploy 블루/그린을 안전하게 사용하도록 구성하는 형태입니다. (템플릿은 실제 값(AMI, SG, Subnet 등) 교체 필요). ([AWS 문서][3])

다음은 문서의 핵심 포인트(요약 — 문서 전체를 직접 확인해도 됨)와 **즉시 적용할 체크리스트, 검증 명령어, 실패 시 롤백 방법, 운영 팁**이다. (문서 내부의 전체 코드/스크립트는 올려둔 텍스트 문서에서 확인하세요.)

# 핵심 포인트 (왜 이렇게 구성했나)

1. AppSpec 훅을 통해 배포의 각 단계(트래픽 차단 전, 애플리케이션 중지, 설치 전/후, 시작, 검증)를 명확히 분리했다. 이는 **무중단 배포에서 연결 드레이닝, graceful shutdown, 시작 전 의존성 설치, 서비스 준비 확인**을 보장한다. ([AWS 문서][2])
2. `ValidateService` 훅은 배포 성공을 결정짓는 최종 게이트로 설계했다. 헬스 체크가 200을 반환할 때까지 재시도하도록 해 배포가 준비되지 않은 상태로 트래픽을 전환하는 위험을 줄인다. ([Stack Overflow][4])
3. ALB TargetGroup의 `deregistration_delay.timeout_seconds` 기본(300초)을 반영하고, 긴 연결/keep-alive를 고려해 충분한 시간을 주도록 권장했다. 이는 세션 끊김을 최소화하는 핵심 설정이다. ([AWS 문서][5])
4. CloudFormation 조각은 CodeDeploy의 ASG 기반 블루/그린 워크플로우와 충돌하지 않도록 `DeploymentStyle: BLUE_GREEN` 및 관련 옵션을 포함했다. 단, EC2 단일 인스턴스(ASG 미사용)와 혼용하지 말고 전략을 통일해야 한다. ([Stack Overflow][6], [AWS 문서][3])

# 즉시 적용 체크리스트 (순서대로)

1. 문서에 있는 `scripts/*.sh`에 실행 권한 부여: `chmod +x scripts/*.sh`
2. `appspec.yml`을 아티팩트 루트에 포함해서 S3로 업로드(또는 GitLab artifact).
3. CloudFormation에서 `ami-REPLACE_ME`, `sg-REPLACE_ME`, `SubnetIds`, `VpcId`, `KeyName` 등을 환경 값으로 채움.
4. 인스턴스의 `UserData`에 `codedeploy-agent` 설치 스크립트 추가(부팅 시 자동 등록).
5. GitLab -> AWS 접근 방식은 가능하면 **OIDC/AssumeRole**로 전환. (액세스 키 직접 사용 금지 권장). ([Instil][7])

# 운영 중 확인(검증) 명령어

* 배포 목록/상태 확인:
  `aws deploy list-deployments --application-name BlueGreen-App`
  `aws deploy get-deployment --deployment-id <DEPLOYMENT_ID>` ([AWS 문서][1])
* TargetGroup 헬스 상태:
  `aws elbv2 describe-target-health --target-group-arn <TARGET_GROUP_ARN>` ([AWS 문서][8])
* 인스턴스 내부 헬스 확인:
  `curl -v http://localhost/health`
* 훅 로그 확인:
  `sudo tail -n 200 /var/log/codedeploy/hooks-*.log` 및 `sudo journalctl -u codedeploy-agent -n 200`

# 실패 상황과 롤백

* `ValidateService` 실패 → CodeDeploy는 배포를 실패로 처리. 자동 롤백을 설정하면 이전(블루) 환경으로 회귀 가능. 수동으로는 `aws deploy stop-deployment --deployment-id <DEPLOYMENT_ID> --auto-rollback-enabled` 사용. ([AWS 문서][9])

# 운영 팁 & 보안

* ALB의 드레인 시간(기본 300s)은 그대로 두고 서비스 특성에 따라 줄이거나 늘리기(예: 단응답 서비스면 5초로 줄일 수 있음). ([AWS 문서][10])
* CodeDeploy Service Role에는 AWS 관리형 `AWSCodeDeployRole`을 우선 사용하되, 운영 규정에 맞춰 최소 권한 원칙으로 세부 조정.
* CloudFormation으로 인프라를 관리하면 재현성과 변경 이력이 보장되지만, CodeDeploy 블루/그린(EC2) 구성은 ASG 기반이어야 CloudFormation+CodeDeploy의 자동화 이점이 커진다. ([AWS 문서][3])

---

다음 단계 제안 (선택 사항 중 빠른 우선순위)

1. 내가 생성한 문서의 `UserData` 섹션에 들어갈 **codedeploy-agent 설치 및 bootstrap 스크립트**를 지금 환경(AMI, OS: Amazon Linux2/Ubuntu 등)에 맞춰 완성해 드리겠다.
2. 실제 GitLab CI 파이프라인 job 예시(`.gitlab-ci.yml`)로 S3 업로드 + `aws deploy create-deployment` 호출 스텝을 작성해 드리겠다.
3. CloudFormation 템플릿을 귀하의 실제 값(Subnet, AMI, SG 등)으로 채워서 완전한 스택 템플릿으로 발전시켜 드리겠다.

---

아래 **세 가지 질문**으로 다음 작업을 정확히 맞추겠다. 각각 응답해 주면 바로 반영·수정해서 문서를 업데이트하겠다.

**Q1. 현재 EC2 AMI/OS(예: Amazon Linux 2 / Ubuntu 22.04)와 인스턴스 부팅 시 사용하려는 AMI ID를 알려 달라.** (UserData와 패키지 설치 스크립트를 해당 OS에 맞춰 조정함)

**Q2. GitLab CI에서 현재 어떤 인증 방식(액세스 키 / OIDC assume-role / 다른 방식)을 사용 중인가?** (보안 권고와 파이프라인 스크립트가 달라짐)

**Q3. 배포 파이프라인에서 DB 마이그레이션(스키마 변경)을 포함할 예정인가? 포함하면 마이그레이션 전략(비호환 변경 여부)을 알려 달라.**

원하면, Q1\~Q3에 대한 답을 바로 보내주면 내가 문서(CloudFormation UserData, `.gitlab-ci.yml` 예시, `appspec` 훅 추가 조정)를 즉시 반영하여 문서를 업데이트하겠다.

[1]: https://docs.aws.amazon.com/codedeploy/latest/userguide/reference-appspec-file.html?utm_source=chatgpt.com "CodeDeploy AppSpec file reference - AWS Documentation"
[2]: https://docs.aws.amazon.com/codedeploy/latest/userguide/reference-appspec-file-structure-hooks.html?utm_source=chatgpt.com "AppSpec 'hooks' section - AWS CodeDeploy"
[3]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/blue-green-template-example.html?utm_source=chatgpt.com "Blue/green deployment template example - AWS CloudFormation"
[4]: https://stackoverflow.com/questions/37967838/using-codedeploy-validateservice-hook-with-python-application?utm_source=chatgpt.com "Using CodeDeploy ValidateService Hook with Python Application"
[5]: https://docs.aws.amazon.com/elasticloadbalancing/latest/application/edit-target-group-attributes.html?utm_source=chatgpt.com "Edit target group attributes for your Application Load Balancer"
[6]: https://stackoverflow.com/questions/68262855/aws-cloudformation-blue-green-deployments-for-ec2?utm_source=chatgpt.com "AWS CloudFormation blue/green deployments for EC2"
[7]: https://instil.co/blog/fearless-deployments-with-codedeploy/?utm_source=chatgpt.com "Fearless deployments with CodeDeploy - Instil Software"
[8]: https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-target-groups.html?utm_source=chatgpt.com "Target groups for your Application Load Balancers"
[9]: https://docs.aws.amazon.com/codedeploy/latest/userguide/reference-appspec-file-example.html?utm_source=chatgpt.com "AppSpec File example - AWS CodeDeploy"
[10]: https://docs.aws.amazon.com/AmazonECS/latest/developerguide/load-balancer-connection-draining.html?utm_source=chatgpt.com "Optimize load balancer connection draining parameters for Amazon ..."
