# Enhanced NGINX Upstream Configuration for ALB Integration
# 4 Application Instances per EC2 for Dual EC2 + AWS ALB Architecture

# Application Backend Pool (4 instances per EC2)
# Each instance runs on consecutive ports: 3001, 3002, 3003, 3004
upstream app_backend {
    # Load balancing method - least_conn for better distribution
    least_conn;
    
    # Application instances (4 per EC2)
    server 127.0.0.1:3001 max_fails=2 fail_timeout=30s weight=1;
    server 127.0.0.1:3002 max_fails=2 fail_timeout=30s weight=1;
    server 127.0.0.1:3003 max_fails=2 fail_timeout=30s weight=1;
    server 127.0.0.1:3004 max_fails=2 fail_timeout=30s weight=1;
    
    # Connection pooling for performance
    keepalive 32;
    keepalive_requests 1000;
    keepalive_timeout 60s;
}

# Health check specific upstream (for ALB health checks)
# Distributes health checks across all instances
upstream health_backend {
    # Round-robin for health checks
    server 127.0.0.1:3001 max_fails=1 fail_timeout=5s;
    server 127.0.0.1:3002 max_fails=1 fail_timeout=5s;
    server 127.0.0.1:3003 max_fails=1 fail_timeout=5s;
    server 127.0.0.1:3004 max_fails=1 fail_timeout=5s;
    
    # Minimal keepalive for health checks
    keepalive 8;
}

# Fallback upstream for emergency situations
# Routes to any available instance when primary upstream fails
upstream fallback_backend {
    # Backup configuration - tries instances in order
    server 127.0.0.1:3001 max_fails=5 fail_timeout=10s;
    server 127.0.0.1:3002 max_fails=5 fail_timeout=10s backup;
    server 127.0.0.1:3003 max_fails=5 fail_timeout=10s backup;
    server 127.0.0.1:3004 max_fails=5 fail_timeout=10s backup;
    
    keepalive 16;
}

# Development/Testing upstream for direct instance access
# Useful for debugging and testing individual instances
upstream instance_1 {
    server 127.0.0.1:3001 max_fails=1 fail_timeout=5s;
    keepalive 4;
}

upstream instance_2 {
    server 127.0.0.1:3002 max_fails=1 fail_timeout=5s;
    keepalive 4;
}

upstream instance_3 {
    server 127.0.0.1:3003 max_fails=1 fail_timeout=5s;
    keepalive 4;
}

upstream instance_4 {
    server 127.0.0.1:3004 max_fails=1 fail_timeout=5s;
    keepalive 4;
}