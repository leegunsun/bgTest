# NGINX Upstream Configuration for Complete Blue-Green Deployment
# Supports single environment, dual synchronized, and load balancing modes

# Individual environment upstreams (existing functionality)
upstream blue {
    server blue-app:3001 max_fails=3 fail_timeout=30s;
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

upstream green {
    server green-app:3002 max_fails=3 fail_timeout=30s;
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# NEW: Dual environment load balancing upstream
# Active when both environments run the same version
upstream dual {
    # Round-robin load balancing between both environments
    server blue-app:3001 max_fails=3 fail_timeout=30s weight=1;
    server green-app:3002 max_fails=3 fail_timeout=30s weight=1;
    
    # Enhanced connection management for load balancing
    keepalive 64;                    # Increased for dual environment
    keepalive_requests 200;          # Higher request volume handling
    keepalive_timeout 60s;
    
    # Load balancing method (can be changed to ip_hash, least_conn, etc.)
    # Default: round_robin
}

# NEW: Weighted load balancing upstream for canary deployments
upstream canary {
    # 90% traffic to stable, 10% to new version (example weights)
    server blue-app:3001 max_fails=2 fail_timeout=20s weight=90;
    server green-app:3002 max_fails=2 fail_timeout=20s weight=10;
    
    keepalive 32;
    keepalive_requests 150;
    keepalive_timeout 60s;
}

# Enhanced fallback upstream with intelligent routing
upstream fallback {
    # Primary-backup configuration with health monitoring
    server blue-app:3001 max_fails=2 fail_timeout=20s;
    server green-app:3002 max_fails=2 fail_timeout=20s backup;
    keepalive 16;
}

# NEW: High availability upstream for maximum redundancy
upstream ha {
    # Both servers active, automatic failover
    server blue-app:3001 max_fails=1 fail_timeout=10s;
    server green-app:3002 max_fails=1 fail_timeout=10s;
    
    # Faster recovery for HA scenarios
    keepalive 48;
    keepalive_requests 300;
    keepalive_timeout 75s;
}