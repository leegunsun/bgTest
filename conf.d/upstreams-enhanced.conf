# Enhanced NGINX Upstream Configuration for Complete Load Balancing
# Production-ready Blue-Green deployment with health checks and gradual migration

# Blue Environment with Advanced Health Checks
upstream blue {
    zone blue 64k;
    server blue-app:3001 max_fails=3 fail_timeout=30s weight=100;
    keepalive 32;
    keepalive_requests 1000;
    keepalive_timeout 60s;
    
    # Health check configuration (requires nginx-plus or custom module)
    # For open-source nginx, we rely on passive health checks
    
    # Backup server configuration for failover
    # server fallback-app:3001 backup;
}

# Green Environment with Advanced Health Checks  
upstream green {
    zone green 64k;
    server green-app:3002 max_fails=3 fail_timeout=30s weight=100;
    keepalive 32;
    keepalive_requests 1000;
    keepalive_timeout 60s;
    
    # Health check configuration
    # Backup server configuration for failover
    # server fallback-app:3002 backup;
}

# Canary/Gradual Migration Upstream - Mixed Environment
upstream canary_blue_green {
    zone canary 64k;
    
    # Dynamic weights - controlled by load balancer
    # Default: 100% to current active environment
    # During migration: gradual weight shift
    server blue-app:3001 weight=100 max_fails=2 fail_timeout=10s;
    server green-app:3002 weight=0 max_fails=2 fail_timeout=10s;
    
    # Advanced keepalive settings for mixed traffic
    keepalive 48;
    keepalive_requests 1000;
    keepalive_timeout 90s;
}

# Fallback upstream for critical failure scenarios
upstream fallback {
    server blue-app:3001;
    server green-app:3002 backup;
    keepalive 16;
}

# Health check upstream - for validation purposes
upstream health_check {
    server blue-app:3001;
    server green-app:3002;
    keepalive 8;
}