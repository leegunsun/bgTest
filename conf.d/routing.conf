# Backend Routing Configuration for True Blue-Green Deployment
# Enhanced with backward compatibility and optional advanced features

# PRIMARY BACKEND ROUTING (Core functionality - must always work)
map $active $backend {
    default         blue;        # Safe default
    blue            blue;        # Blue traffic → blue upstream  
    green           green;       # Green traffic → green upstream
    
    # Enhanced modes (only active when upstreams are configured)
    dual            dual;        # Load balanced dual environment
    loadbalance     dual;        # Alias for load balancing
    canary          canary;      # Weighted canary deployment
    ha              ha;          # High availability mode
    fallback        fallback;    # Fallback/backup mode
}

# Optional: Canary deployment with percentage-based routing
# Only activated when $active is set to "canary"
split_clients "$remote_addr$request_id" $canary_bucket {
    10%     canary_new;          # 10% to new version
    *       canary_stable;       # 90% to stable version
}

# Canary target mapping
map $canary_bucket $canary_target {
    default         blue;        # Safe fallback
    canary_stable   blue;        # Stable version
    canary_new      green;       # New version
}

# Deployment mode support (optional, defaults to single mode)
map $deployment_mode $backend_override {
    default         "";          # No override - use primary routing
    dual            "dual";      # Force dual mode
    canary          "canary";    # Force canary mode
    ha              "ha";        # Force HA mode
}