---
# .gitlab-ci.yml â€” DEV Blue/Green íŒŒì´í”„ë¼ì¸ (í…ŒìŠ¤íŠ¸ í™˜ê²½ìš©)
# ê¸°ì¡´ í”„ë¡œë•ì…˜ ê·œì¹™ì„ ë³´ì¡´í•˜ë©´ì„œ Node.js í…ŒìŠ¤íŠ¸ í™˜ê²½ì— ìµœì í™”

stages:
  - build-dev
  - test-dev
  - detect-env-dev
  - deploy-dev
  - health-check-dev
  - switch-traffic-dev
  - verify-dev
  - cleanup-dev

# ê³µí†µ ë³€ìˆ˜ (í…ŒìŠ¤íŠ¸ í™˜ê²½ìš© ìˆ˜ì •)
variables:
  GIT_DEPTH: "0"
  NODE_OPTIONS: "--max_old_space_size=2048"
  NPM_CACHE_FOLDER: "$CI_PROJECT_DIR/.npm"
  DOCKER_DRIVER: overlay2

# NPM ìºì‹œ â€” ë¸Œëœì¹˜ë³„ë¡œ ë¶„ë¦¬
cache:
  key: "npm-$CI_COMMIT_REF_SLUG"
  paths:
    - .npm
    - node_modules/

# ì¬ì‚¬ìš© ê·œì¹™ (dev, main ë¸Œëœì¹˜ë§Œ) â€” ì›ë³¸ ìœ ì§€
.rules_dev_and_main: &rules_dev_main
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - when: never

# ì¬ì‚¬ìš© Alpine ì„¸íŒ… (ssh, curl, docker ë“±) â€” ì›ë³¸ ê¸°ë°˜ í™•ì¥
.alpine_docker_setup: &alpine_docker_setup
  image: alpine:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache bash openssh-client curl ca-certificates docker docker-compose
    - eval $(ssh-agent -s)
    # Environment variables debugging
    - echo "ğŸ” GitLab CI/CD Variables Debugging:"
    - echo "- AWS_PEM_DEV exists:" $(if [ -n "$AWS_PEM_DEV" ]; then echo "âœ… YES"; else echo "âŒ NO"; fi)
    - echo "- AWS_PEM_DEV length:" $(if [ -n "$AWS_PEM_DEV" ]; then echo ${#AWS_PEM_DEV} "characters"; else echo "0 (empty)"; fi)
    - echo "- DEPLOY_SERVER_DEV exists:" $(if [ -n "$DEPLOY_SERVER_DEV" ]; then echo "âœ… YES"; else echo "âŒ NO"; fi)
    - echo "- DEPLOY_SERVER_DEV value:" $(if [ -n "$DEPLOY_SERVER_DEV" ]; then echo "$DEPLOY_SERVER_DEV"; else echo "(empty)"; fi)
    - echo "- DEV_ENV_FILE exists:" $(if [ -n "$DEV_ENV_FILE" ]; then echo "âœ… YES"; else echo "âŒ NO"; fi)
    - echo "- DEV_ENV_FILE length:" $(if [ -n "$DEV_ENV_FILE" ]; then echo ${#DEV_ENV_FILE} "characters"; else echo "0 (empty)"; fi)
    - |
      if [ -z "$AWS_PEM_DEV" ]; then
        echo ""
        echo "âŒ ERROR: AWS_PEM_DEV variable not configured properly in GitLab CI/CD"
        echo ""
        echo "ğŸ“‹ GitLab CI/CD Variables Configuration Guide:"
        echo "1. Go to: Project â†’ Settings â†’ CI/CD â†’ Variables"
        echo "2. Add these variables:"
        echo "   - AWS_PEM_DEV (Type: File) - EC2 SSH private key content"
        echo "   - DEPLOY_SERVER_DEV (Type: Variable) - EC2 IP/hostname"
        echo "   - DEV_ENV_FILE (Type: File) - Environment config file"
        echo ""
        echo "âš ï¸  Make sure to:"
        echo "   - Set 'Protected' to âœ… for all variables"
        echo "   - Set 'Masked' to âŒ for File type variables"
        echo "   - Set 'Masked' to âœ… for Variable type (DEPLOY_SERVER_DEV)"
        echo ""
        echo "ğŸ”‘ For AWS_PEM_DEV (File type):"
        echo "   - Copy entire SSH private key including:"
        echo "     -----BEGIN OPENSSH PRIVATE KEY-----"
        echo "     [key content]"
        echo "     -----END OPENSSH PRIVATE KEY-----"
        echo ""
        exit 1
      fi
    - echo "âœ… All required environment variables are configured"
    - echo "ğŸ”‘ Setting up SSH key permissions..."
    - chmod 600 "$AWS_PEM_DEV"
    - ssh-add "$AWS_PEM_DEV"
    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
    - echo "âœ… SSH setup completed successfully"

# 1) Build â€” Node.js í™˜ê²½ìš©ìœ¼ë¡œ ìˆ˜ì •
build-dev:
  stage: build-dev
  image: node:18-alpine
  <<: *rules_dev_main
  before_script:
    - npm config set cache $NPM_CACHE_FOLDER
  script:
    - echo "Building Node.js Blue-Green test environment..."
    # Node.js ì˜ì¡´ì„± ì„¤ì¹˜ (ìˆëŠ” ê²½ìš°)
    - if [ -f "package.json" ]; then npm ci; fi
    - if [ -f "package.json" ]; then npm run build || echo "No build script defined"; fi
    - echo "Preparing test environment files..."
    - cp "$DEV_ENV_FILE" ./.env || echo "No env file configured"
    - echo "Creating deployment script files..."
    - cp ./deploy-bluegreen.sh ./deploy-green.sh
    - cp ./switch-deployment.sh ./switch-to-green.sh
    - cp ./switch-deployment.sh ./rollback-to-blue.sh
    - cp ./health-check.sh ./cleanup-blue.sh
    - echo "Preparing Docker build context..."
    - ls -al blue-server/ green-server/
    - echo "ğŸ” Checking shell scripts for artifacts..."
    - ls -la *.sh || echo "No .sh files found in build context"
    - echo "ğŸ“ All files for artifacts:"
    - ls -la
  artifacts:
    expire_in: 3 days
    paths:
      - ./blue-server/
      - ./green-server/
      - ./api-server/
      - ./nginx.conf
      - ./conf.d/
      - ./admin.html
      - ./docker-compose.yml
      - ./Dockerfile
      - ./.env
      - ./start.sh
      - ./switch-deployment.sh
      - ./deploy-green.sh
      - ./switch-to-green.sh
      - ./rollback-to-blue.sh
      - ./cleanup-blue.sh
      - ./health-check.sh
      - ./detect-active-env.sh

# 2) Test â€” Node.js ê¸°ë³¸ í…ŒìŠ¤íŠ¸
test-dev:
  stage: test-dev
  image: node:18-alpine
  <<: *rules_dev_main
  needs: ["build-dev"]
  script:
    - echo "Running Node.js tests for Blue-Green servers..."
    # Node.js í…ŒìŠ¤íŠ¸ (ìˆëŠ” ê²½ìš°)
    - if [ -f "package.json" ]; then npm test || echo "No test script defined"; fi
    - echo "Checking Blue/Green server syntax..."
    - node -c blue-server/app.js
    - node -c green-server/app.js
    - echo "Checking NGINX configuration syntax..."
  artifacts:
    when: always
    expire_in: 3 days
    paths:
      - test-results/

# 2.5) Environment Detection â€” ìƒˆë¡œìš´ ë‹¨ê³„: í˜„ì¬ í™œì„± í™˜ê²½ ê°ì§€ ë° ë°°í¬ ëŒ€ìƒ ê²°ì •
detect-active-environment:
  stage: detect-env-dev
  <<: [*alpine_docker_setup, *rules_dev_main]
  needs: ["build-dev", "test-dev"]
  script:
    - echo "ğŸ” Detecting current active environment on remote server..."
    - |
      ssh "ubuntu@$DEPLOY_SERVER_DEV" 'cd ~/bgTest/v5ToWindow
      echo "ğŸ“Š Current Environment Detection:"

      # í˜¸ìŠ¤íŠ¸ì—ì„œ í˜„ì¬ í™œì„± í™˜ê²½ ê°ì§€ (ì»¨í…Œì´ë„ˆ ì™¸ë¶€)
      if [ -f "./detect-active-env.sh" ]; then
        chmod +x ./detect-active-env.sh
        echo "Running environment detection on host..."
        CURRENT_ACTIVE=$(./detect-active-env.sh current 2>/dev/null || echo "green")
        DEPLOY_TARGET=$(./detect-active-env.sh next 2>/dev/null || echo "blue")
      else
        echo "âš ï¸ Environment detection script not found, using fallback detection..."
        # ì»¨í…Œì´ë„ˆì—ì„œ ì§ì ‘ í™•ì¸
        CURRENT_ACTIVE=$(sudo docker exec blue-green-nginx sh -c "if grep -q \"green\" /etc/nginx/conf.d/active.env 2>/dev/null; then echo \"green\"; else echo \"blue\"; fi" 2>/dev/null || echo "green")
        if [ "$CURRENT_ACTIVE" = "green" ]; then
          DEPLOY_TARGET="blue"
        else
          DEPLOY_TARGET="green"
        fi
      fi

      echo "CURRENT_ACTIVE=$CURRENT_ACTIVE"
      echo "DEPLOY_TARGET=$DEPLOY_TARGET"
      echo "TARGET_PORT=$(if [ \"$DEPLOY_TARGET\" = \"blue\" ]; then echo \"3001\"; else echo \"3002\"; fi)"
      echo "TARGET_ENV_NAME=${DEPLOY_TARGET}-dev"

      # Save to file for next stages
      echo "$CURRENT_ACTIVE" > ~/current_active.env
      echo "$DEPLOY_TARGET" > ~/deploy_target.env
      '
  artifacts:
    expire_in: 1 hour
    paths:
      - environment_detection.env

# 3) Dynamic Remote deploy to inactive environment â€” ê°œì„ ëœ ë™ì  ë°°í¬
deploy-inactive-environment:
  stage: deploy-dev
  <<: [*alpine_docker_setup, *rules_dev_main]
  needs: ["detect-active-environment", "build-dev", "test-dev"]
  environment:
    name: inactive-env
    url: "http://$DEPLOY_SERVER_DEV"  # ë™ì ìœ¼ë¡œ ê²°ì •ë¨
  script:
    - echo "Deploying to Docker-based Blue-Green environment..."
    - echo "ğŸ” Checking local files before transfer..."
    - ls -la *.sh || echo "No .sh files found locally"
    - echo "ğŸ“ Current directory contents:"
    - ls -la
    - echo "Creating target directory..."
    - ssh "ubuntu@$DEPLOY_SERVER_DEV" "mkdir -p ~/bgTest/v5ToWindow"
    - echo "ğŸ“ Copying project files to target server..."
    - scp -r ./blue-server/           "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp -r ./green-server/          "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp -r ./api-server/            "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp -r ./conf.d/                "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./.env                      "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/.env"
    - scp ./nginx.conf                "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./docker-compose.yml        "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./Dockerfile                "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./admin.html                "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./start.sh                  "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./switch-deployment.sh      "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./deploy-green.sh           "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./switch-to-green.sh        "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./rollback-to-blue.sh       "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./cleanup-blue.sh           "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./health-check.sh           "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./detect-active-env.sh      "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - echo "ğŸ” Verifying transferred files on EC2..."
    - ssh "ubuntu@$DEPLOY_SERVER_DEV" "cd ~/bgTest/v5ToWindow && ls -la *.sh || echo 'No .sh files found'"
    - echo "ğŸ³ Setting up Docker environment and rebuilding containers..."
    - |
      ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        # Docker ì„¤ì¹˜ í™•ì¸ ë° ìë™ ì„¤ì¹˜
        echo \"ğŸ” Checking Docker installation...\"
        if ! command -v docker &> /dev/null; then
          echo \"ğŸ“¦ Installing Docker...\"
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo usermod -aG docker ubuntu
          sudo systemctl start docker
          sudo systemctl enable docker
          echo \"âœ… Docker installed successfully\"
        else
          echo \"âœ… Docker is already installed\"
        fi

        # Docker Compose ì„¤ì¹˜ í™•ì¸ ë° ìë™ ì„¤ì¹˜
        if ! command -v docker-compose &> /dev/null; then
          echo \"ğŸ“¦ Installing Docker Compose...\"
          sudo curl -L \"https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-\$(uname -s)-\$(uname -m)\" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
          echo \"âœ… Docker Compose installed successfully\"
        else
          echo \"âœ… Docker Compose is already installed\"
        fi

        # ì„¤ì¹˜ ë²„ì „ í™•ì¸
        docker --version
        docker-compose --version
      "'
    - echo "Starting Docker container deployment process..."
    - |
      ssh "ubuntu@$DEPLOY_SERVER_DEV" 'cd ~/bgTest/v5ToWindow
      echo "ğŸ”„ Starting deployment process..."
      echo "ğŸ›‘ Stopping existing containers..."
      sudo docker-compose down --timeout 30 || true
      echo "ğŸ§¹ Cleaning up old images..."
      sudo docker image prune -f || true
      echo "ğŸ—ï¸ Rebuilding Docker image..."
      sudo docker build --no-cache -t blue-green-nginx .
      echo "ğŸš€ Starting updated containers..."
      sudo docker-compose up -d
      echo "â³ Waiting for containers to be ready..."
      sleep 45
      echo "ğŸ“Š Container status:"
      sudo docker ps --filter name=blue-green-nginx
      echo "ğŸ¥ Docker health status:"
      for i in $(seq 1 12); do
        health_status=$(sudo docker inspect --format="{{.State.Health.Status}}" blue-green-nginx 2>/dev/null || echo "no-healthcheck")
        echo "Health check attempt $i - $health_status"
        if [ "$health_status" = "healthy" ]; then
          echo "âœ… Container is healthy!"
          break
        elif [ "$health_status" = "no-healthcheck" ]; then
          echo "âš ï¸ No healthcheck configured, checking manually..."
          if sudo docker exec blue-green-nginx curl -f http://localhost/status >/dev/null 2>&1; then
            echo "âœ… Manual health check passed!"
            break
          fi
        fi
        if [ $i -eq 12 ]; then
          echo "âŒ Container failed to become healthy"
          sudo docker logs --tail 50 blue-green-nginx
          exit 1
        fi
        sleep 10
      done
      echo "âœ… Deployment completed successfully!"'

# 4) Health check â€” ë™ì  í™˜ê²½ í—¬ìŠ¤ì²´í¬ ë¡œì§
health-check-inactive-env:
  stage: health-check-dev
  <<: [*alpine_docker_setup, *rules_dev_main]
  needs: ["deploy-inactive-environment"]
  retry: 2
  script:
    - |
      ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        echo \"ğŸ¥ Health checking Blue-Green test environment...\"
        echo \"â³ Waiting for Docker containers to fully start...\"
        sleep 30

        # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
        echo \"ğŸ“Š Docker container status:\"
        sudo docker ps --filter name=blue-green-nginx --format \"table {{.Names}}\t{{.Status}}\t{{.Ports}}\"

        # ê°œì„ ëœ í—¬ìŠ¤ì²´í¬ ë¡œì§
        check_service() {
          local service_name=\"\$1\"
          local port=\"\$2\"
          local endpoint=\"\$3\"
          local max_attempts=15
          local success_count=0
          local required_successes=2

          echo \"ğŸ” Checking \$service_name (port \$port, endpoint \$endpoint)...\"

          for i in \$(seq 1 \$max_attempts); do
            status=\$(curl -s -o /dev/null -w \"%{http_code}\" \\
                           --max-time 8 --connect-timeout 3 \\
                           --retry 1 --retry-delay 1 \\
                           \"http://localhost:\$port\$endpoint\" 2>/dev/null || echo \"000\")

            if [ \"\$status\" = \"200\" ]; then
              success_count=\$((success_count + 1))
              echo \"  âœ… \$service_name OK (attempt \$i) - success \$success_count/\$required_successes\"

              if [ \$success_count -ge \$required_successes ]; then
                echo \"  ğŸ‰ \$service_name is stable!\"
                return 0
              fi
            else
              success_count=0
              echo \"  âŒ \$service_name not ready (HTTP \$status) - attempt \$i/\$max_attempts\"
            fi

            if [ \$i -lt \$max_attempts ]; then
              sleep 3
            fi
          done

          echo \"  ğŸ’¥ \$service_name health check failed after \$max_attempts attempts\"
          return 1
        }

        # ì„œë¹„ìŠ¤ë³„ í—¬ìŠ¤ì²´í¬ ì‹¤í–‰
        overall_status=0

        # NGINX í”„ë¡ì‹œ í—¬ìŠ¤ì²´í¬
        if ! check_service \"NGINX Proxy\" \"80\" \"/status\"; then
          overall_status=1
          echo \"âš ï¸ NGINX proxy health check failed\"
          # NGINX ë¡œê·¸ í™•ì¸
          echo \"ğŸ“‹ NGINX error logs (last 10 lines):\"
          sudo docker exec blue-green-nginx tail -n 10 /var/log/nginx/error.log 2>/dev/null || echo \"No error logs found\"
        fi

        # Blue ì„œë²„ í—¬ìŠ¤ì²´í¬
        if ! check_service \"Blue Server\" \"3001\" \"/health\"; then
          overall_status=1
          echo \"âš ï¸ Blue server health check failed\"
        fi

        # ë°°í¬ëœ í™˜ê²½ í™•ì¸ ë° í—¬ìŠ¤ì²´í¬
        DEPLOY_TARGET=\$(cat ~/deploy_target.env 2>/dev/null || echo \"green\")
        TARGET_PORT=\$(if [ \"\$DEPLOY_TARGET\" = \"blue\" ]; then echo \"3001\"; else echo \"3002\"; fi)

        echo \"ğŸ¯ Checking deployed environment: \$DEPLOY_TARGET (port \$TARGET_PORT)\"
        if ! check_service \"\$DEPLOY_TARGET Server\" \"\$TARGET_PORT\" \"/health\"; then
          overall_status=1
          echo \"âš ï¸ \$DEPLOY_TARGET server health check failed\"
        fi

        # API ì„œë²„ í—¬ìŠ¤ì²´í¬ (ì„ íƒì )
        if ! check_service \"API Server\" \"9000\" \"/health\"; then
          echo \"âš ï¸ API server health check failed (non-critical)\"
          # API ì„œë²„ëŠ” ë¹„í•„ìˆ˜ì´ë¯€ë¡œ overall_statusì— ì˜í–¥ ì£¼ì§€ ì•ŠìŒ
        fi

        if [ \$overall_status -eq 0 ]; then
          echo \"\"
          echo \"ğŸ‰ All critical services are healthy!\"
          echo \"âœ… NGINX Proxy: Ready\"
          echo \"âœ… Blue Server: Ready\"
          echo \"âœ… Green Server: Ready\"
          exit 0
        else
          echo \"\"
          echo \"âŒ Health check failed - some services are not ready\"
          echo \"ğŸ’¡ Troubleshooting commands:\"
          echo \"  sudo docker logs blue-green-nginx\"
          echo \"  sudo docker exec blue-green-nginx ps aux\"
          echo \"  sudo docker exec blue-green-nginx netstat -tlnp\"
          exit 1
        fi
      "'

# 5) Switch traffic to inactive environment â€” ë™ì  íŠ¸ë˜í”½ ì „í™˜
switch-traffic-to-inactive:
  stage: switch-traffic-dev
  <<: [*alpine_docker_setup, *rules_dev_main]
  needs: ["health-check-inactive-env"]
  environment:
    name: production-dev
    url: "http://$DEPLOY_SERVER_DEV"
  when: manual  # ì›ë³¸ì˜ ìˆ˜ë™ ì‹¤í–‰ ì •ì±… ìœ ì§€
  allow_failure: false
  script:
    - |
      ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        cd ~/bgTest/v5ToWindow
        DEPLOY_TARGET=\$(cat ~/deploy_target.env 2>/dev/null || echo \"green\")
        echo \"ğŸ”„ Switching traffic to \$DEPLOY_TARGET environment...\"
        sudo docker exec blue-green-nginx ./switch-deployment.sh \$DEPLOY_TARGET
        echo \"âœ… Traffic switched to \$DEPLOY_TARGET\"
        echo \"ğŸ“Š New configuration:\"
        if [ -f \"./detect-active-env.sh\" ]; then
          chmod +x ./detect-active-env.sh
          ./detect-active-env.sh status || echo \"Environment detection script not available\"
        else
          echo \"Environment detection completed - \$DEPLOY_TARGET now active\"
        fi
      "'

# 6) Verify after switch â€” ë™ì  í™˜ê²½ ê²€ì¦ ë¡œì§
verify-switch:
  stage: verify-dev
  image: alpine:latest
  <<: *rules_dev_main
  needs: ["switch-traffic-to-inactive"]
  script:
    - apk add --no-cache curl
    - |
      echo "ğŸ” Verifying Blue-Green deployment switch..."
      echo "â³ Waiting for services to be fully ready..."
      sleep 30  # ì¦ê°€: 10ì´ˆ â†’ 30ì´ˆ

      # ê°œì„ ëœ í—¬ìŠ¤ì²´í¬ ë¡œì§
      max_attempts=15  # ì¦ê°€: 10 â†’ 15
      success_count=0
      required_successes=3  # ì¦ê°€: 2 â†’ 3

      for i in $(seq 1 $max_attempts); do
        echo "ğŸ”„ Health check attempt $i/$max_attempts..."

        # ë©”ì¸ í”„ë¡ì‹œ í—¬ìŠ¤ì²´í¬ (íƒ€ì„ì•„ì›ƒ ì¦ê°€)
        main_code=$(curl -s -o /dev/null -w '%{http_code}' \
                         --max-time 15 --connect-timeout 8 \
                         --retry 3 --retry-delay 2 \
                         "http://$DEPLOY_SERVER_DEV/status" 2>/dev/null || echo "000")
        echo "  ğŸ“Š Main proxy (/status) => HTTP $main_code"

        # í”„ë¡ì‹œë¥¼ í†µí•œ ê²€ì¦ë§Œ ìˆ˜í–‰ (ë³´ì•ˆ ê·¸ë£¹ ì´ìŠˆ íšŒí”¼)
        # NGINX í”„ë¡ì‹œë¥¼ í†µí•œ Blue/Green ì „í™˜ ê²€ì¦
        proxy_blue_code=$(curl -s -o /dev/null -w '%{http_code}' \
                               --max-time 15 --connect-timeout 8 \
                               --retry 3 --retry-delay 2 \
                               "http://$DEPLOY_SERVER_DEV/blue/" 2>/dev/null || echo "000")
        echo "  ğŸ”µ Proxy â†’ Blue server => HTTP $proxy_blue_code"
        proxy_green_code=$(curl -s -o /dev/null -w '%{http_code}' \
                                --max-time 15 --connect-timeout 8 \
                                --retry 3 --retry-delay 2 \
                                "http://$DEPLOY_SERVER_DEV/green/" 2>/dev/null || echo "000")
        echo "  ğŸŸ¢ Proxy â†’ Green server => HTTP $proxy_green_code"

        # ë™ì  ì„±ê³µ ì¡°ê±´: ë©”ì¸ í”„ë¡ì‹œì™€ í˜„ì¬ í™œì„±í™”ëœ í™˜ê²½ ëª¨ë‘ ì„±ê³µ
        # ì–´ë–¤ í™˜ê²½ì´ í˜„ì¬ í™œì„±ì¸ì§€ ë¨¼ì € í™•ì¸
        active_env="green"  # ê¸°ë³¸ê°’, ì‹¤ì œë¡œëŠ” ë™ì ìœ¼ë¡œ ê²°ì •ë¨
        target_code="$proxy_green_code"

        # Blueì™€ Green ì¤‘ ì–´ëŠ ê²ƒì´ ì‘ë‹µí•˜ëŠ”ì§€ í™•ì¸í•˜ì—¬ í˜„ì¬ í™œì„± í™˜ê²½ íŒë‹¨
        if [ "$proxy_blue_code" = "200" ] && [ "$proxy_green_code" != "200" ]; then
          active_env="blue"
          target_code="$proxy_blue_code"
        elif [ "$proxy_green_code" = "200" ]; then
          active_env="green"
          target_code="$proxy_green_code"
        fi

        if [ "$main_code" = "200" ] && [ "$target_code" = "200" ]; then
          success_count=$((success_count + 1))
          echo "  âœ… Success! Active: $active_env ($success_count/$required_successes consecutive successes)"

          if [ $success_count -ge $required_successes ]; then
            echo ""
            echo "ğŸ‰ Blue-Green deployment verification completed successfully!"
            echo "âœ… Main proxy: HTTP $main_code"
            echo "âœ… Active environment: $active_env (HTTP $target_code)"
            echo "â„¹ï¸  Proxy â†’ Blue: HTTP $proxy_blue_code"
            echo "â„¹ï¸  Proxy â†’ Green: HTTP $proxy_green_code"
            exit 0
          fi
        else
          success_count=0
          echo "  âŒ Failed - resetting success count"

          # ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
          if [ "$main_code" != "200" ]; then
            echo "    ğŸ”§ Main proxy issue - check NGINX configuration"
          fi
          if [ "$target_code" != "200" ]; then
            echo "    ğŸ”§ $active_env server proxy routing issue - check NGINX upstream"
          fi
        fi

        # ë§ˆì§€ë§‰ ì‹œë„ê°€ ì•„ë‹ˆë©´ ëŒ€ê¸°
        if [ $i -lt $max_attempts ]; then
          echo "  â³ Waiting 8 seconds before next attempt..."
          sleep 8
        fi
      done

      echo ""
      echo "âŒ Verification failed after $max_attempts attempts"
      echo "ğŸ’¡ Troubleshooting suggestions:"
      echo "  1. Check NGINX proxy access: curl -v http://$DEPLOY_SERVER_DEV/status"
      echo "  2. Verify Docker containers:"
      echo "     ssh ubuntu@$DEPLOY_SERVER_DEV 'sudo docker ps'"
      echo "  3. Check container logs:"
      echo "     ssh ubuntu@$DEPLOY_SERVER_DEV 'sudo docker logs blue-green-nginx'"
      echo "  4. Test proxy routing:"
      echo "     curl -v http://$DEPLOY_SERVER_DEV/blue/"
      echo "     curl -v http://$DEPLOY_SERVER_DEV/green/"
      echo "  5. Check internal connectivity:"
      echo "     ssh ubuntu@$DEPLOY_SERVER_DEV 'sudo docker exec blue-green-nginx curl localhost:3001/health'"
      echo "  6. Verify NGINX configuration:"
      echo "     ssh ubuntu@$DEPLOY_SERVER_DEV 'sudo docker exec blue-green-nginx nginx -t'"
      exit 1

# 7-a) Cleanup inactive environment â€” ë™ì  ì •ë¦¬
cleanup-inactive-env:
  stage: cleanup-dev
  <<: [*alpine_docker_setup, *rules_dev_main]
  needs: ["verify-switch"]
  when: manual  # ì›ë³¸ì˜ ìˆ˜ë™ ì‹¤í–‰ ì •ì±… ìœ ì§€
  allow_failure: true
  environment:
    name: inactive-env
    url: "http://$DEPLOY_SERVER_DEV"
  script:
    - |
      ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        cd ~/bgTest/v5ToWindow
        CURRENT_ACTIVE=\$(cat ~/current_active.env 2>/dev/null || echo \"blue\")
        echo \"ğŸ§¹ Cleaning up previously active \$CURRENT_ACTIVE environment...\"
        echo \"Previous \$CURRENT_ACTIVE environment cleanup completed (container-based)\"
        echo \"â„¹ï¸  Both environments remain available for instant rollback\"
      "'

# 7-b) Rollback to previous environment â€” ë™ì  ë¡¤ë°±
rollback-to-previous:
  stage: cleanup-dev
  <<: [*alpine_docker_setup, *rules_dev_main]
  when: manual  # ì›ë³¸ì˜ ìˆ˜ë™ ì‹¤í–‰ ì •ì±… ìœ ì§€
  allow_failure: false
  environment:
    name: production-dev
    url: "http://$DEPLOY_SERVER_DEV"
  script:
    - |
      ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        cd ~/bgTest/v5ToWindow
        PREVIOUS_ACTIVE=\$(cat ~/current_active.env 2>/dev/null || echo \"blue\")
        echo \"ğŸ”„ Rolling back to previous \$PREVIOUS_ACTIVE environment...\"
        sudo docker exec blue-green-nginx ./switch-deployment.sh \$PREVIOUS_ACTIVE
        echo \"âœ… Rollback to \$PREVIOUS_ACTIVE completed\"
        echo \"ğŸ“Š Rollback status:\"
        sudo docker exec blue-green-nginx ./detect-active-env.sh status
      "'
