# .gitlab-ci.yml â€” DEV Blue/Green íŒŒì´í”„ë¼ì¸ (í…ŒìŠ¤íŠ¸ í™˜ê²½ìš©)
# ê¸°ì¡´ í”„ë¡œë•ì…˜ ê·œì¹™ì„ ë³´ì¡´í•˜ë©´ì„œ Node.js í…ŒìŠ¤íŠ¸ í™˜ê²½ì— ìµœì í™”

stages:
  - build-dev
  - test-dev
  - deploy-dev
  - health-check-dev
  - switch-traffic-dev
  - verify-dev
  - cleanup-dev

# ê³µí†µ ë³€ìˆ˜ (í…ŒìŠ¤íŠ¸ í™˜ê²½ìš© ìˆ˜ì •)
variables:
  GIT_DEPTH: "0"
  NODE_OPTIONS: "--max_old_space_size=2048"
  NPM_CACHE_FOLDER: "$CI_PROJECT_DIR/.npm"
  DOCKER_DRIVER: overlay2

# NPM ìºì‹œ â€” ë¸Œëœì¹˜ë³„ë¡œ ë¶„ë¦¬
cache:
  key: "npm-$CI_COMMIT_REF_SLUG"
  paths:
    - .npm
    - node_modules/

# ì¬ì‚¬ìš© ê·œì¹™ (dev, main ë¸Œëœì¹˜ë§Œ) â€” ì›ë³¸ ìœ ì§€
.rules_dev_and_main: &rules_dev_main
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - when: never

# ì¬ì‚¬ìš© Alpine ì„¸íŒ… (ssh, curl, docker ë“±) â€” ì›ë³¸ ê¸°ë°˜ í™•ì¥
.alpine_docker_setup: &alpine_docker_setup
  image: alpine:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache bash openssh-client curl ca-certificates docker docker-compose
    - eval $(ssh-agent -s)
    # Environment variables debugging
    - echo "ğŸ” GitLab CI/CD Variables Debugging:"
    - echo "- AWS_PEM_DEV exists:" $(if [ -n "$AWS_PEM_DEV" ]; then echo "âœ… YES"; else echo "âŒ NO"; fi)
    - echo "- AWS_PEM_DEV length:" $(if [ -n "$AWS_PEM_DEV" ]; then echo ${#AWS_PEM_DEV} "characters"; else echo "0 (empty)"; fi)
    - echo "- DEPLOY_SERVER_DEV exists:" $(if [ -n "$DEPLOY_SERVER_DEV" ]; then echo "âœ… YES"; else echo "âŒ NO"; fi)
    - echo "- DEPLOY_SERVER_DEV value:" $(if [ -n "$DEPLOY_SERVER_DEV" ]; then echo "$DEPLOY_SERVER_DEV"; else echo "(empty)"; fi)
    - echo "- DEV_ENV_FILE exists:" $(if [ -n "$DEV_ENV_FILE" ]; then echo "âœ… YES"; else echo "âŒ NO"; fi)
    - echo "- DEV_ENV_FILE length:" $(if [ -n "$DEV_ENV_FILE" ]; then echo ${#DEV_ENV_FILE} "characters"; else echo "0 (empty)"; fi)
    - |
      if [ -z "$AWS_PEM_DEV" ]; then
        echo ""
        echo "âŒ ERROR: AWS_PEM_DEV variable not configured properly in GitLab CI/CD"
        echo ""
        echo "ğŸ“‹ GitLab CI/CD Variables Configuration Guide:"
        echo "1. Go to: Project â†’ Settings â†’ CI/CD â†’ Variables"
        echo "2. Add these variables:"
        echo "   - AWS_PEM_DEV (Type: File) - EC2 SSH private key content"
        echo "   - DEPLOY_SERVER_DEV (Type: Variable) - EC2 IP/hostname" 
        echo "   - DEV_ENV_FILE (Type: File) - Environment config file"
        echo ""
        echo "âš ï¸  Make sure to:"
        echo "   - Set 'Protected' to âœ… for all variables"
        echo "   - Set 'Masked' to âŒ for File type variables"
        echo "   - Set 'Masked' to âœ… for Variable type (DEPLOY_SERVER_DEV)"
        echo ""
        echo "ğŸ”‘ For AWS_PEM_DEV (File type):"
        echo "   - Copy entire SSH private key including:"
        echo "     -----BEGIN OPENSSH PRIVATE KEY-----"
        echo "     [key content]"
        echo "     -----END OPENSSH PRIVATE KEY-----"
        echo ""
        exit 1
      fi
    - echo "âœ… All required environment variables are configured"
    - echo "ğŸ”‘ Setting up SSH key permissions..."
    - chmod 600 "$AWS_PEM_DEV"
    - ssh-add "$AWS_PEM_DEV"
    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
    - echo "âœ… SSH setup completed successfully"

# 1) Build â€” Node.js í™˜ê²½ìš©ìœ¼ë¡œ ìˆ˜ì •
build-dev:
  stage: build-dev
  image: node:18-alpine
  <<: *rules_dev_main
  before_script:
    - npm config set cache $NPM_CACHE_FOLDER
  script:
    - echo "Building Node.js Blue-Green test environment..."
    # Node.js ì˜ì¡´ì„± ì„¤ì¹˜ (ìˆëŠ” ê²½ìš°)
    - if [ -f "package.json" ]; then npm ci; fi
    - if [ -f "package.json" ]; then npm run build || echo "No build script defined"; fi
    - echo "Preparing test environment files..."
    - cp "$DEV_ENV_FILE" ./.env || echo "No env file configured"
    - echo "Creating deployment script files..."
    - cp ./deploy-bluegreen.sh ./deploy-green.sh
    - cp ./switch-deployment.sh ./switch-to-green.sh
    - cp ./switch-deployment.sh ./rollback-to-blue.sh
    - cp ./health-check.sh ./cleanup-blue.sh
    - echo "Preparing Docker build context..."
    - ls -al blue-server/ green-server/
    - echo "ğŸ” Checking shell scripts for artifacts..."
    - ls -la *.sh || echo "No .sh files found in build context"
    - echo "ğŸ“ All files for artifacts:"
    - ls -la
  artifacts:
    expire_in: 3 days
    paths:
      - ./blue-server/
      - ./green-server/
      - ./api-server/
      - ./nginx.conf
      - ./conf.d/
      - ./admin.html
      - ./docker-compose.yml
      - ./Dockerfile
      - ./.env
      - ./start.sh
      - ./switch-deployment.sh
      - ./deploy-green.sh
      - ./switch-to-green.sh
      - ./rollback-to-blue.sh
      - ./cleanup-blue.sh
      - ./health-check.sh

# 2) Test â€” Node.js ê¸°ë³¸ í…ŒìŠ¤íŠ¸
test-dev:
  stage: test-dev
  image: node:18-alpine
  <<: *rules_dev_main
  needs: ["build-dev"]
  dependencies: ["build-dev"]
  script:
    - echo "Running Node.js tests for Blue-Green servers..."
    # Node.js í…ŒìŠ¤íŠ¸ (ìˆëŠ” ê²½ìš°)
    - if [ -f "package.json" ]; then npm test || echo "No test script defined"; fi
    - echo "Checking Blue/Green server syntax..."
    - node -c blue-server/app.js
    - node -c green-server/app.js
    - echo "Checking NGINX configuration syntax..."
  artifacts:
    when: always
    expire_in: 3 days
    paths:
      - test-results/

# 3) Remote deploy to Docker container â€” í•µì‹¬ ìˆ˜ì • ë¶€ë¶„
deploy-green-dev:
  stage: deploy-dev
  <<: [*alpine_docker_setup, *rules_dev_main]
  needs: ["build-dev","test-dev"]
  dependencies: ["build-dev","test-dev"]
  environment:
    name: green-dev
    url: "http://$DEPLOY_SERVER_DEV:3002"  # Green ì„œë²„ í¬íŠ¸ë¡œ ë³€ê²½
  script:
    - echo "Deploying to Docker-based Blue-Green environment..."
    - echo "ğŸ” Checking local files before transfer..."
    - ls -la *.sh || echo "No .sh files found locally"
    - echo "ğŸ“ Current directory contents:"
    - ls -la
    - echo "Creating target directory..."
    - ssh "ubuntu@$DEPLOY_SERVER_DEV" "mkdir -p ~/bgTest/v5ToWindow"
    - echo "ğŸ“ Copying project files to target server..."
    - scp -r ./blue-server/           "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp -r ./green-server/          "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp -r ./api-server/            "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp -r ./conf.d/                "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./.env                      "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/.env"
    - scp ./nginx.conf                "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./docker-compose.yml        "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./Dockerfile                "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./admin.html                "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./start.sh                  "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./switch-deployment.sh      "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./deploy-green.sh           "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./switch-to-green.sh        "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./rollback-to-blue.sh       "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./cleanup-blue.sh           "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./health-check.sh           "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - echo "ğŸ” Verifying transferred files on EC2..."
    - ssh "ubuntu@$DEPLOY_SERVER_DEV" "cd ~/bgTest/v5ToWindow && ls -la *.sh || echo 'No .sh files found'"
    - echo "ğŸ³ Setting up Docker environment and rebuilding containers..."
    - |
      ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        # Docker ì„¤ì¹˜ í™•ì¸ ë° ìë™ ì„¤ì¹˜
        echo \"ğŸ” Checking Docker installation...\"
        if ! command -v docker &> /dev/null; then
          echo \"ğŸ“¦ Installing Docker...\"
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo usermod -aG docker ubuntu
          sudo systemctl start docker
          sudo systemctl enable docker
          echo \"âœ… Docker installed successfully\"
        else
          echo \"âœ… Docker is already installed\"
        fi
        
        # Docker Compose ì„¤ì¹˜ í™•ì¸ ë° ìë™ ì„¤ì¹˜
        if ! command -v docker-compose &> /dev/null; then
          echo \"ğŸ“¦ Installing Docker Compose...\"
          sudo curl -L \"https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-\$(uname -s)-\$(uname -m)\" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
          echo \"âœ… Docker Compose installed successfully\"
        else
          echo \"âœ… Docker Compose is already installed\"
        fi
        
        # ì„¤ì¹˜ ë²„ì „ í™•ì¸
        docker --version
        docker-compose --version
      "'
    
    # ìƒˆ ì„¸ì…˜ì—ì„œ Docker ê·¸ë£¹ ê¶Œí•œìœ¼ë¡œ ë°°í¬ ì‹¤í–‰
    - ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        cd ~/bgTest/v5ToWindow && 
        echo \"ğŸ”„ Starting deployment process...\" &&
        
        # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
        echo \"ğŸ›‘ Stopping existing containers...\" &&
        sudo docker-compose down --timeout 30 || true &&
        
        # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬ (ë””ìŠ¤í¬ ê³µê°„ í™•ë³´)
        echo \"ğŸ§¹ Cleaning up old images...\" &&
        sudo docker image prune -f || true &&
        
        # Docker ì´ë¯¸ì§€ ì¬ë¹Œë“œ
        echo \"ğŸ—ï¸ Rebuilding Docker image...\" &&
        sudo docker build --no-cache -t blue-green-nginx . &&
        
        # ì»¨í…Œì´ë„ˆ ì‹œì‘
        echo \"ğŸš€ Starting updated containers...\" &&
        sudo docker-compose up -d &&
        
        # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
        echo \"â³ Waiting for containers to be ready...\" &&
        sleep 20 &&
        
        # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
        echo \"ğŸ“Š Container status:\" &&
        sudo docker ps --filter name=blue-green-nginx &&
        
        # Docker í—¬ìŠ¤ì²´í¬ ìƒíƒœ í™•ì¸
        echo \"ğŸ¥ Docker health status:\" &&
        for i in \$(seq 1 12); do
          health_status=\$(sudo docker inspect --format=\"{{.State.Health.Status}}\" blue-green-nginx 2>/dev/null || echo \"no-healthcheck\")
          echo \"Health check attempt \$i: \$health_status\"
          
          if [ \"\$health_status\" = \"healthy\" ]; then
            echo \"âœ… Container is healthy!\"
            break
          elif [ \"\$health_status\" = \"no-healthcheck\" ]; then
            echo \"âš ï¸ No healthcheck configured, checking manually...\"
            # ìˆ˜ë™ í—¬ìŠ¤ì²´í¬
            if sudo docker exec blue-green-nginx curl -f http://localhost/status >/dev/null 2>&1; then
              echo \"âœ… Manual health check passed!\"
              break
            fi
          fi
          
          if [ \$i -eq 12 ]; then
            echo \"âŒ Container failed to become healthy\"
            sudo docker logs --tail 50 blue-green-nginx
            exit 1
          fi
          
          sleep 10
        done &&
        
        echo \"âœ… Deployment completed successfully!\"
      "'

# 4) Health check â€” ê°œì„ ëœ í—¬ìŠ¤ì²´í¬ ë¡œì§
health-check-dev:
  stage: health-check-dev
  <<: [*alpine_docker_setup, *rules_dev_main]
  needs: ["deploy-green-dev"]
  retry: 2
  script:
    - |
      ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        echo \"ğŸ¥ Health checking Blue-Green test environment...\"
        echo \"â³ Waiting for Docker containers to fully start...\"
        sleep 15
        
        # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
        echo \"ğŸ“Š Docker container status:\"
        sudo docker ps --filter name=blue-green-nginx --format \"table {{.Names}}\t{{.Status}}\t{{.Ports}}\"
        
        # ê°œì„ ëœ í—¬ìŠ¤ì²´í¬ ë¡œì§
        check_service() {
          local service_name=\"\$1\"
          local port=\"\$2\"
          local endpoint=\"\$3\"
          local max_attempts=15
          local success_count=0
          local required_successes=2
          
          echo \"ğŸ” Checking \$service_name (port \$port, endpoint \$endpoint)...\"
          
          for i in \$(seq 1 \$max_attempts); do
            status=\$(curl -s -o /dev/null -w \"%{http_code}\" \\
                           --max-time 8 --connect-timeout 3 \\
                           --retry 1 --retry-delay 1 \\
                           \"http://localhost:\$port\$endpoint\" 2>/dev/null || echo \"000\")
            
            if [ \"\$status\" = \"200\" ]; then
              success_count=\$((success_count + 1))
              echo \"  âœ… \$service_name OK (attempt \$i) - success \$success_count/\$required_successes\"
              
              if [ \$success_count -ge \$required_successes ]; then
                echo \"  ğŸ‰ \$service_name is stable!\"
                return 0
              fi
            else
              success_count=0
              echo \"  âŒ \$service_name not ready (HTTP \$status) - attempt \$i/\$max_attempts\"
            fi
            
            if [ \$i -lt \$max_attempts ]; then
              sleep 3
            fi
          done
          
          echo \"  ğŸ’¥ \$service_name health check failed after \$max_attempts attempts\"
          return 1
        }
        
        # ì„œë¹„ìŠ¤ë³„ í—¬ìŠ¤ì²´í¬ ì‹¤í–‰
        overall_status=0
        
        # NGINX í”„ë¡ì‹œ í—¬ìŠ¤ì²´í¬
        if ! check_service \"NGINX Proxy\" \"80\" \"/status\"; then
          overall_status=1
          echo \"âš ï¸ NGINX proxy health check failed\"
          # NGINX ë¡œê·¸ í™•ì¸
          echo \"ğŸ“‹ NGINX error logs (last 10 lines):\"
          sudo docker exec blue-green-nginx tail -n 10 /var/log/nginx/error.log 2>/dev/null || echo \"No error logs found\"
        fi
        
        # Blue ì„œë²„ í—¬ìŠ¤ì²´í¬
        if ! check_service \"Blue Server\" \"3001\" \"/health\"; then
          overall_status=1
          echo \"âš ï¸ Blue server health check failed\"
        fi
        
        # Green ì„œë²„ í—¬ìŠ¤ì²´í¬
        if ! check_service \"Green Server\" \"3002\" \"/health\"; then
          overall_status=1
          echo \"âš ï¸ Green server health check failed\"
        fi
        
        # API ì„œë²„ í—¬ìŠ¤ì²´í¬ (ì„ íƒì )
        if ! check_service \"API Server\" \"9000\" \"/health\"; then
          echo \"âš ï¸ API server health check failed (non-critical)\"
          # API ì„œë²„ëŠ” ë¹„í•„ìˆ˜ì´ë¯€ë¡œ overall_statusì— ì˜í–¥ ì£¼ì§€ ì•ŠìŒ
        fi
        
        if [ \$overall_status -eq 0 ]; then
          echo \"\"
          echo \"ğŸ‰ All critical services are healthy!\"
          echo \"âœ… NGINX Proxy: Ready\"
          echo \"âœ… Blue Server: Ready\"
          echo \"âœ… Green Server: Ready\"
          exit 0
        else
          echo \"\"
          echo \"âŒ Health check failed - some services are not ready\"
          echo \"ğŸ’¡ Troubleshooting commands:\"
          echo \"  sudo docker logs blue-green-nginx\"
          echo \"  sudo docker exec blue-green-nginx ps aux\"
          echo \"  sudo docker exec blue-green-nginx netstat -tlnp\"
          exit 1
        fi
      "'

# 5) Switch traffic to GREEN â€” ì›ë³¸ êµ¬ì¡° ìœ ì§€, ìŠ¤í¬ë¦½íŠ¸ í˜¸ì¶œ ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •
switch-traffic-dev:
  stage: switch-traffic-dev
  <<: [*alpine_docker_setup, *rules_dev_main]
  needs: ["health-check-dev"]
  environment:
    name: production-dev
    url: "http://$DEPLOY_SERVER_DEV"
  when: manual  # ì›ë³¸ì˜ ìˆ˜ë™ ì‹¤í–‰ ì •ì±… ìœ ì§€
  allow_failure: false
  script:
    - ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        cd ~/bgTest/v5ToWindow && 
        echo \"Switching to Green environment...\" &&
        sudo docker exec blue-green-nginx ./switch-deployment.sh green &&
        echo \"âœ… Traffic switched to Green\"
      "'

# 6) Verify after switch â€” ê°œì„ ëœ í—¬ìŠ¤ì²´í¬ ë¡œì§
verify-dev:
  stage: verify-dev
  image: alpine:latest
  <<: *rules_dev_main
  needs: ["switch-traffic-dev"]
  script:
    - apk add --no-cache curl
    - |
      echo "ğŸ” Verifying Blue-Green deployment switch..."
      echo "â³ Waiting for services to be fully ready..."
      sleep 10
      
      # ê°œì„ ëœ í—¬ìŠ¤ì²´í¬ ë¡œì§
      max_attempts=10
      success_count=0
      required_successes=2
      
      for i in $(seq 1 $max_attempts); do
        echo "ğŸ”„ Health check attempt $i/$max_attempts..."
        
        # ë©”ì¸ í”„ë¡ì‹œ í—¬ìŠ¤ì²´í¬ (íƒ€ì„ì•„ì›ƒ ì¦ê°€)
        main_code=$(curl -s -o /dev/null -w '%{http_code}' \
                         --max-time 10 --connect-timeout 5 \
                         --retry 2 --retry-delay 1 \
                         "http://$DEPLOY_SERVER_DEV/status" 2>/dev/null || echo "000")
        echo "  ğŸ“Š Main proxy (/status) => HTTP $main_code"
        
        # Green ì„œë²„ ì§ì ‘ í—¬ìŠ¤ì²´í¬
        green_code=$(curl -s -o /dev/null -w '%{http_code}' \
                          --max-time 10 --connect-timeout 5 \
                          --retry 2 --retry-delay 1 \
                          "http://$DEPLOY_SERVER_DEV:3002/health" 2>/dev/null || echo "000")
        echo "  ğŸŸ¢ Green server => HTTP $green_code"
        
        # Blue ì„œë²„ë„ í™•ì¸ (ì „ì²´ì ì¸ ìƒíƒœ íŒŒì•…)
        blue_code=$(curl -s -o /dev/null -w '%{http_code}' \
                         --max-time 10 --connect-timeout 5 \
                         --retry 2 --retry-delay 1 \
                         "http://$DEPLOY_SERVER_DEV:3001/health" 2>/dev/null || echo "000")
        echo "  ğŸ”µ Blue server => HTTP $blue_code"
        
        # ì„±ê³µ ì¡°ê±´: ë©”ì¸ í”„ë¡ì‹œì™€ Green ì„œë²„ ëª¨ë‘ 200
        if [ "$main_code" = "200" ] && [ "$green_code" = "200" ]; then
          success_count=$((success_count + 1))
          echo "  âœ… Success! ($success_count/$required_successes consecutive successes)"
          
          if [ $success_count -ge $required_successes ]; then
            echo ""
            echo "ğŸ‰ Verification completed successfully!"
            echo "âœ… Main proxy: HTTP $main_code"
            echo "âœ… Green server: HTTP $green_code" 
            echo "â„¹ï¸  Blue server: HTTP $blue_code"
            exit 0
          fi
        else
          success_count=0
          echo "  âŒ Failed - resetting success count"
          
          # ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
          if [ "$main_code" != "200" ]; then
            echo "    ğŸ”§ Main proxy issue - check NGINX configuration"
          fi
          if [ "$green_code" != "200" ]; then
            echo "    ğŸ”§ Green server issue - check Node.js service"
          fi
        fi
        
        # ë§ˆì§€ë§‰ ì‹œë„ê°€ ì•„ë‹ˆë©´ ëŒ€ê¸°
        if [ $i -lt $max_attempts ]; then
          echo "  â³ Waiting 5 seconds before next attempt..."
          sleep 5
        fi
      done
      
      echo ""
      echo "âŒ Verification failed after $max_attempts attempts"
      echo "ğŸ’¡ Troubleshooting suggestions:"
      echo "  1. Check EC2 security groups allow ports 80, 3001, 3002"
      echo "  2. Verify Docker containers are running: docker ps"
      echo "  3. Check NGINX logs: docker logs blue-green-nginx"
      echo "  4. Test manual connectivity: curl -v http://$DEPLOY_SERVER_DEV/status"
      exit 1

# 7-a) Cleanup BLUE â€” ì›ë³¸ êµ¬ì¡° ìœ ì§€, Docker í™˜ê²½ìš© ìˆ˜ì •
cleanup-dev:
  stage: cleanup-dev
  <<: [*alpine_docker_setup, *rules_dev_main]
  needs: ["verify-dev"]
  when: manual  # ì›ë³¸ì˜ ìˆ˜ë™ ì‹¤í–‰ ì •ì±… ìœ ì§€
  allow_failure: true
  environment:
    name: blue-dev
    url: "http://$DEPLOY_SERVER_DEV:3001"  # Blue ì„œë²„ í¬íŠ¸ë¡œ ë³€ê²½
  script:
    - ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        cd ~/bgTest/v5ToWindow && 
        echo \"Cleaning up inactive Blue environment...\" &&
        echo \"Blue environment cleanup completed (container-based)\"
      "'

# 7-b) Rollback to BLUE â€” ì›ë³¸ êµ¬ì¡° ìœ ì§€, ìŠ¤í¬ë¦½íŠ¸ í˜¸ì¶œ ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •
rollback-to-blue-dev:
  stage: cleanup-dev
  <<: [*alpine_docker_setup, *rules_dev_main]
  when: manual  # ì›ë³¸ì˜ ìˆ˜ë™ ì‹¤í–‰ ì •ì±… ìœ ì§€
  allow_failure: false
  environment:
    name: production-dev
    url: "http://$DEPLOY_SERVER_DEV"
  script:
    - ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        cd ~/bgTest/v5ToWindow && 
        echo \"Rolling back to Blue environment...\" &&
        sudo docker exec blue-green-nginx ./switch-deployment.sh blue &&
        echo \"âœ… Rollback to Blue completed\"
      "'