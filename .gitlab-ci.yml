# .gitlab-ci.yml â€” DEV Blue/Green íŒŒì´í”„ë¼ì¸ (í…ŒìŠ¤íŠ¸ í™˜ê²½ìš©)
# ê¸°ì¡´ í”„ë¡œë•ì…˜ ê·œì¹™ì„ ë³´ì¡´í•˜ë©´ì„œ Node.js í…ŒìŠ¤íŠ¸ í™˜ê²½ì— ìµœì í™”

stages:
  - build-dev
  - test-dev
  - deploy-dev
  - health-check-dev
  - switch-traffic-dev
  - verify-dev
  - cleanup-dev

# ê³µí†µ ë³€ìˆ˜ (í…ŒìŠ¤íŠ¸ í™˜ê²½ìš© ìˆ˜ì •)
variables:
  GIT_DEPTH: "0"
  NODE_OPTIONS: "--max_old_space_size=2048"
  NPM_CACHE_FOLDER: "$CI_PROJECT_DIR/.npm"
  DOCKER_DRIVER: overlay2

# NPM ìºì‹œ â€” ë¸Œëœì¹˜ë³„ë¡œ ë¶„ë¦¬
cache:
  key: "npm-$CI_COMMIT_REF_SLUG"
  paths:
    - .npm
    - node_modules/

# ì¬ì‚¬ìš© ê·œì¹™ (dev, main ë¸Œëœì¹˜ë§Œ) â€” ì›ë³¸ ìœ ì§€
.rules_dev_and_main: &rules_dev_main
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - when: never

# ì¬ì‚¬ìš© Alpine ì„¸íŒ… (ssh, curl, docker ë“±) â€” ì›ë³¸ ê¸°ë°˜ í™•ì¥
.alpine_docker_setup: &alpine_docker_setup
  image: alpine:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache bash openssh-client curl ca-certificates docker docker-compose
    - eval $(ssh-agent -s)
    # Environment variables debugging
    - echo "ğŸ” GitLab CI/CD Variables Debugging:"
    - echo "- AWS_PEM_DEV exists:" $(if [ -n "$AWS_PEM_DEV" ]; then echo "âœ… YES"; else echo "âŒ NO"; fi)
    - echo "- AWS_PEM_DEV length:" $(if [ -n "$AWS_PEM_DEV" ]; then echo ${#AWS_PEM_DEV} "characters"; else echo "0 (empty)"; fi)
    - echo "- DEPLOY_SERVER_DEV exists:" $(if [ -n "$DEPLOY_SERVER_DEV" ]; then echo "âœ… YES"; else echo "âŒ NO"; fi)
    - echo "- DEPLOY_SERVER_DEV value:" $(if [ -n "$DEPLOY_SERVER_DEV" ]; then echo "$DEPLOY_SERVER_DEV"; else echo "(empty)"; fi)
    - echo "- DEV_ENV_FILE exists:" $(if [ -n "$DEV_ENV_FILE" ]; then echo "âœ… YES"; else echo "âŒ NO"; fi)
    - echo "- DEV_ENV_FILE length:" $(if [ -n "$DEV_ENV_FILE" ]; then echo ${#DEV_ENV_FILE} "characters"; else echo "0 (empty)"; fi)
    - |
      if [ -z "$AWS_PEM_DEV" ]; then
        echo ""
        echo "âŒ ERROR: AWS_PEM_DEV variable not configured properly in GitLab CI/CD"
        echo ""
        echo "ğŸ“‹ GitLab CI/CD Variables Configuration Guide:"
        echo "1. Go to: Project â†’ Settings â†’ CI/CD â†’ Variables"
        echo "2. Add these variables:"
        echo "   - AWS_PEM_DEV (Type: File) - EC2 SSH private key content"
        echo "   - DEPLOY_SERVER_DEV (Type: Variable) - EC2 IP/hostname" 
        echo "   - DEV_ENV_FILE (Type: File) - Environment config file"
        echo ""
        echo "âš ï¸  Make sure to:"
        echo "   - Set 'Protected' to âœ… for all variables"
        echo "   - Set 'Masked' to âŒ for File type variables"
        echo "   - Set 'Masked' to âœ… for Variable type (DEPLOY_SERVER_DEV)"
        echo ""
        echo "ğŸ”‘ For AWS_PEM_DEV (File type):"
        echo "   - Copy entire SSH private key including:"
        echo "     -----BEGIN OPENSSH PRIVATE KEY-----"
        echo "     [key content]"
        echo "     -----END OPENSSH PRIVATE KEY-----"
        echo ""
        exit 1
      fi
    - echo "âœ… All required environment variables are configured"
    - echo "ğŸ”‘ Setting up SSH key permissions..."
    - chmod 600 "$AWS_PEM_DEV"
    - ssh-add "$AWS_PEM_DEV"
    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
    - echo "âœ… SSH setup completed successfully"

# 1) Build â€” Node.js í™˜ê²½ìš©ìœ¼ë¡œ ìˆ˜ì •
build-dev:
  stage: build-dev
  image: node:18-alpine
  <<: *rules_dev_main
  before_script:
    - npm config set cache $NPM_CACHE_FOLDER
  script:
    - echo "Building Node.js Blue-Green test environment..."
    # Node.js ì˜ì¡´ì„± ì„¤ì¹˜ (ìˆëŠ” ê²½ìš°)
    - if [ -f "package.json" ]; then npm ci; fi
    - if [ -f "package.json" ]; then npm run build || echo "No build script defined"; fi
    
    # í…ŒìŠ¤íŠ¸ í™˜ê²½ íŒŒì¼ ì¤€ë¹„
    - cp "$DEV_ENV_FILE" ./.env || echo "No env file configured"
    
    # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ìƒì„± (ì›ë³¸ íŒ¨í„´ ìœ ì§€)
    - cp ./deploy-bluegreen.sh ./deploy-green.sh
    - cp ./switch-deployment.sh ./switch-to-green.sh
    - cp ./switch-deployment.sh ./rollback-to-blue.sh
    - cp ./health-check.sh ./cleanup-blue.sh
    
    # Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤€ë¹„
    - echo "Preparing Docker build context..."
    - ls -al blue-server/ green-server/
    
  artifacts:
    expire_in: 3 days
    paths:
      - ./blue-server/
      - ./green-server/  
      - ./nginx.conf
      - ./conf.d/
      - ./admin.html
      - ./docker-compose.yml
      - ./Dockerfile
      - ./.env
      - ./deploy-green.sh
      - ./switch-to-green.sh
      - ./rollback-to-blue.sh
      - ./cleanup-blue.sh
      - ./health-check.sh

# 2) Test â€” Node.js ê¸°ë³¸ í…ŒìŠ¤íŠ¸
test-dev:
  stage: test-dev
  image: node:18-alpine
  <<: *rules_dev_main
  needs: ["build-dev"]
  dependencies: ["build-dev"]
  script:
    - echo "Running Node.js tests for Blue-Green servers..."
    # Node.js í…ŒìŠ¤íŠ¸ (ìˆëŠ” ê²½ìš°)
    - if [ -f "package.json" ]; then npm test || echo "No test script defined"; fi
    
    # Blue/Green ì„œë²„ êµ¬ë¬¸ ê²€ì‚¬
    - node -c blue-server/app.js
    - node -c green-server/app.js
    
    # NGINX ì„¤ì • ê²€ì‚¬ (ë¡œì»¬ì—ì„œ)
    - echo "Checking NGINX configuration syntax..."
    
  artifacts:
    when: always
    expire_in: 3 days
    paths:
      - test-results/

# 3) Remote deploy to Docker container â€” í•µì‹¬ ìˆ˜ì • ë¶€ë¶„
deploy-green-dev:
  stage: deploy-dev
  <<: *alpine_docker_setup
  <<: *rules_dev_main
  needs: ["build-dev","test-dev"]
  dependencies: ["build-dev","test-dev"]
  environment:
    name: green-dev
    url: "http://$DEPLOY_SERVER_DEV:3002"  # Green ì„œë²„ í¬íŠ¸ë¡œ ë³€ê²½
  script:
    - echo "Deploying to Docker-based Blue-Green environment..."
    
    # ëŒ€ìƒ ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„)
    - ssh "ubuntu@$DEPLOY_SERVER_DEV" "mkdir -p ~/bgTest/v5ToWindow"
    
    # ì „ì²´ í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬
    - scp -r ./blue-server/           "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp -r ./green-server/          "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp -r ./conf.d/                "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./.env                      "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/.env"
    - scp ./nginx.conf                "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./docker-compose.yml        "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./Dockerfile                "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./admin.html                "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./deploy-green.sh           "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./switch-to-green.sh        "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./rollback-to-blue.sh       "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./cleanup-blue.sh           "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    - scp ./health-check.sh           "ubuntu@$DEPLOY_SERVER_DEV:~/bgTest/v5ToWindow/"
    
    # Docker í™˜ê²½ ì„¤ì • ë° ì»¨í…Œì´ë„ˆ ì¬ë¹Œë“œ
    - |
      ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        # Docker ì„¤ì¹˜ í™•ì¸ ë° ìë™ ì„¤ì¹˜
        echo \"ğŸ” Checking Docker installation...\"
        if ! command -v docker &> /dev/null; then
          echo \"ğŸ“¦ Installing Docker...\"
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo usermod -aG docker ubuntu
          sudo systemctl start docker
          sudo systemctl enable docker
          echo \"âœ… Docker installed successfully\"
        else
          echo \"âœ… Docker is already installed\"
        fi
        
        # Docker Compose ì„¤ì¹˜ í™•ì¸ ë° ìë™ ì„¤ì¹˜
        if ! command -v docker-compose &> /dev/null; then
          echo \"ğŸ“¦ Installing Docker Compose...\"
          sudo curl -L \"https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-\$(uname -s)-\$(uname -m)\" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
          echo \"âœ… Docker Compose installed successfully\"
        else
          echo \"âœ… Docker Compose is already installed\"
        fi
        
        # ì„¤ì¹˜ ë²„ì „ í™•ì¸
        docker --version
        docker-compose --version
      "'
    
    # ìƒˆ ì„¸ì…˜ì—ì„œ Docker ê·¸ë£¹ ê¶Œí•œìœ¼ë¡œ ë°°í¬ ì‹¤í–‰
    - ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        cd ~/bgTest/v5ToWindow && 
        echo \"Stopping existing containers...\" &&
        sudo docker-compose down || true &&
        echo \"Rebuilding Docker image...\" &&
        sudo docker build -t blue-green-nginx . &&
        echo \"Starting updated containers...\" &&
        sudo docker-compose up -d &&
        echo \"âœ… Deployment completed\"
      "'

# 4) Health check â€” í¬íŠ¸ì™€ ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •
health-check-dev:
  stage: health-check-dev
  <<: *alpine_docker_setup
  <<: *rules_dev_main
  needs: ["deploy-green-dev"]
  retry: 1
  script:
    - |
      ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        echo \"Health checking Blue-Green test environment...\"
        
        # NGINX í”„ë¡ì‹œ í—¬ìŠ¤ì²´í¬
        echo \"Checking NGINX proxy (port 80)...\"
        for i in \$(seq 1 10); do
          status=\$(curl -s -o /dev/null -w \"%{http_code}\" http://localhost:80/status || true)
          if [ \"\$status\" = \"200\" ]; then
            echo \"âœ“ NGINX proxy OK on attempt \$i\"
            break
          fi
          echo \"NGINX not ready (HTTP \$status). retry=\$i\"
          sleep 5
        done
        
        # Blue ì„œë²„ í—¬ìŠ¤ì²´í¬ (í¬íŠ¸ 3001)
        echo \"Checking Blue server (port 3001)...\"
        for i in \$(seq 1 10); do
          status=\$(curl -s -o /dev/null -w \"%{http_code}\" http://localhost:3001/health || true)
          if [ \"\$status\" = \"200\" ]; then
            echo \"âœ“ Blue server OK on attempt \$i\"
            break
          fi
          echo \"Blue server not ready (HTTP \$status). retry=\$i\"
          sleep 3
        done
        
        # Green ì„œë²„ í—¬ìŠ¤ì²´í¬ (í¬íŠ¸ 3002)  
        echo \"Checking Green server (port 3002)...\"
        for i in \$(seq 1 10); do
          status=\$(curl -s -o /dev/null -w \"%{http_code}\" http://localhost:3002/health || true)
          if [ \"\$status\" = \"200\" ]; then
            echo \"âœ“ Green server OK on attempt \$i\"
            exit 0
          fi
          echo \"Green server not ready (HTTP \$status). retry=\$i\"
          sleep 3
        done
        
        echo \"Health check failed after 10 tries\"
        exit 1
      "'

# 5) Switch traffic to GREEN â€” ì›ë³¸ êµ¬ì¡° ìœ ì§€, ìŠ¤í¬ë¦½íŠ¸ í˜¸ì¶œ ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •
switch-traffic-dev:
  stage: switch-traffic-dev
  <<: *alpine_docker_setup
  <<: *rules_dev_main
  needs: ["health-check-dev"]
  environment:
    name: production-dev
    url: "http://$DEPLOY_SERVER_DEV"
  when: manual  # ì›ë³¸ì˜ ìˆ˜ë™ ì‹¤í–‰ ì •ì±… ìœ ì§€
  allow_failure: false
  script:
    - ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        cd ~/bgTest/v5ToWindow && 
        echo \"Switching to Green environment...\" &&
        sudo docker exec blue-green-nginx ./switch-deployment.sh green &&
        echo \"âœ… Traffic switched to Green\"
      "'

# 6) Verify after switch â€” ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •
verify-dev:
  stage: verify-dev
  image: alpine:latest
  <<: *rules_dev_main
  needs: ["switch-traffic-dev"]
  script:
    - apk add --no-cache curl
    - |
      echo "Verifying Blue-Green deployment switch..."
      for i in $(seq 1 5); do
        # ë©”ì¸ í”„ë¡ì‹œë¥¼ í†µí•œ ì ‘ê·¼ í™•ì¸
        code=$(curl -s -o /dev/null -w '%{http_code}' "http://$DEPLOY_SERVER_DEV/" || true)
        echo "Main proxy attempt $i => HTTP $code"
        
        # Green ì„œë²„ ì§ì ‘ ì ‘ê·¼ í™•ì¸
        green_code=$(curl -s -o /dev/null -w '%{http_code}' "http://$DEPLOY_SERVER_DEV:3002/health" || true)  
        echo "Green server attempt $i => HTTP $green_code"
        
        if [ "$code" = "200" ] && [ "$green_code" = "200" ]; then
          echo "âœ“ Verification successful"
          exit 0
        fi
        sleep 3
      done
      echo "âœ— Verification failed"
      exit 1

# 7-a) Cleanup BLUE â€” ì›ë³¸ êµ¬ì¡° ìœ ì§€, Docker í™˜ê²½ìš© ìˆ˜ì •
cleanup-dev:
  stage: cleanup-dev
  <<: *alpine_docker_setup
  <<: *rules_dev_main
  needs: ["verify-dev"]
  when: manual  # ì›ë³¸ì˜ ìˆ˜ë™ ì‹¤í–‰ ì •ì±… ìœ ì§€
  allow_failure: true
  environment:
    name: blue-dev
    url: "http://$DEPLOY_SERVER_DEV:3001"  # Blue ì„œë²„ í¬íŠ¸ë¡œ ë³€ê²½
  script:
    - ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        cd ~/bgTest/v5ToWindow && 
        echo \"Cleaning up inactive Blue environment...\" &&
        echo \"Blue environment cleanup completed (container-based)\"
      "'

# 7-b) Rollback to BLUE â€” ì›ë³¸ êµ¬ì¡° ìœ ì§€, ìŠ¤í¬ë¦½íŠ¸ í˜¸ì¶œ ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •
rollback-to-blue-dev:
  stage: cleanup-dev
  <<: *alpine_docker_setup
  <<: *rules_dev_main
  when: manual  # ì›ë³¸ì˜ ìˆ˜ë™ ì‹¤í–‰ ì •ì±… ìœ ì§€
  allow_failure: false
  environment:
    name: production-dev
    url: "http://$DEPLOY_SERVER_DEV"
  script:
    - ssh "ubuntu@$DEPLOY_SERVER_DEV" 'bash -lc "
        cd ~/bgTest/v5ToWindow && 
        echo \"Rolling back to Blue environment...\" &&
        sudo docker exec blue-green-nginx ./switch-deployment.sh blue &&
        echo \"âœ… Rollback to Blue completed\"
      "'"